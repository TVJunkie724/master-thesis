<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Testing Guide — Twin2Clouds Documentation</title>
    <link rel="icon" type="image/x-icon" href="../references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="../css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-solid fa-vial me-2"></i> Testing Guide
            </h1>

            <p class="text-muted mb-4">
                Comprehensive automated test suite ensuring calculation accuracy, pricing reliability, and system
                correctness.
            </p>

            <!-- Testing Overview -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-chart-pie me-2"></i>Testing Overview</h2>
                    <p>
                        Twin2Clouds employs a comprehensive testing strategy to ensure accuracy and reliability across
                        all
                        components.
                        The test suite validates cost calculations, pricing data fetching, schema compliance, and
                        optimization algorithms.
                    </p>

                    <div class="text-center my-4">
                        <img src="../references/testing_categories.png" alt="Testing Categories"
                            class="img-fluid rounded" style="max-width: 100%;">
                    </div>
                </div>
            </div>

            <!-- Test Categories -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list-check me-2"></i>Test Categories</h2>

                    <div class="row">
                        <!-- Unit Tests Column -->
                        <div class="col-md-6">
                            <h3 class="h4 text-primary border-bottom pb-2 mb-3">Unit Tests</h3>

                            <div class="mb-4">
                                <h4 class="h5">1. Formula Verification</h4>
                                <p><strong>Purpose:</strong> Validates mathematical accuracy of pricing calculations.
                                </p>
                                <p><strong>Files:</strong> <code>tests/test_formulas_*.py</code></p>
                                <ul>
                                    <li>Message ingestion costs</li>
                                    <li>Compute execution costs</li>
                                    <li>Storage tier calculations</li>
                                    <li>L4 Twin services (TwinMaker, Digital Twins)</li>
                                </ul>
                            </div>

                            <div class="mb-4">
                                <h4 class="h5">2. Data Transfer Validation</h4>
                                <p><strong>Purpose:</strong> Validates egress and inter-layer transfer cost
                                    calculations.</p>
                                <p><strong>Files:</strong> <code>tests/test_transfer.py</code></p>
                                <ul>
                                    <li>Tiered bandwidth limits</li>
                                    <li>Cross-region transfer costs</li>
                                    <li>Free tier egress logic</li>
                                </ul>
                            </div>

                            <div class="mb-4">
                                <h4 class="h5">3. Cross-Cloud Glue Code</h4>
                                <p><strong>Purpose:</strong> Validates costs for connecting different cloud providers.
                                </p>
                                <p><strong>Files:</strong> <code>tests/test_l4_glue_code.py</code></p>
                                <ul>
                                    <li>Connector functions (L1->L2, L2->L3)</li>
                                    <li>Ingestion/Writer/Reader proxies</li>
                                    <li>API Gateway/Management overhead</li>
                                </ul>
                            </div>

                            <div class="mb-4">
                                <h4 class="h5">4. Schema Validation</h4>
                                <p><strong>Purpose:</strong> Checks JSON structure of the pricing output.</p>
                                <p><strong>Files:</strong> <code>tests/test_pricing_validation.py</code></p>
                                <ul>
                                    <li>Required cloud providers presence</li>
                                    <li>Service structure completeness</li>
                                    <li>Numeric field type validation</li>
                                    <li>Pricing tier structures</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Integration Tests Column -->
                        <div class="col-md-6">
                            <h3 class="h4 text-success border-bottom pb-2 mb-3">Integration Tests</h3>

                            <div class="mb-4">
                                <h4 class="h5">5. Optimization Algorithms</h4>
                                <p><strong>Purpose:</strong> Verifies graph logic and cost minimization.</p>
                                <p><strong>Files:</strong> <code>tests/test_optimization.py</code></p>
                                <ul>
                                    <li>Graph construction for storage transitions</li>
                                    <li>Dijkstra's shortest path algorithm</li>
                                    <li>Provider selection across layers</li>
                                </ul>
                            </div>

                            <div class="mb-4">
                                <h4 class="h5">6. Dynamic Pricing Integration</h4>
                                <p><strong>Purpose:</strong> Tests API fetching and parsing from cloud providers.</p>
                                <p><strong>Files:</strong> <code>tests/test_calculate_pricing_refactored.py</code></p>
                                <ul>
                                    <li>API response parsing</li>
                                    <li>Unit normalization</li>
                                    <li>Error handling and fallbacks</li>
                                    <li>Service-specific field mapping</li>
                                </ul>
                            </div>

                            <div class="mb-4">
                                <h4 class="h5">7. System Orchestration</h4>
                                <p><strong>Purpose:</strong> Tests end-to-end pricing pipeline and error handling.</p>
                                <p><strong>Files:</strong> <code>tests/test_rest_api_endpoints.py</code></p>
                                <ul>
                                    <li>Data fetch and consolidation</li>
                                    <li>Helper function logic</li>
                                    <li>Graceful degradation</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Running Tests -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-play me-2"></i>Running Tests</h2>

                    <h3 class="mb-2">Quick Start (Using Test Script)</h3>
                    <p>The easiest way to run tests is using the provided script:</p>
                    <pre class="p-3 rounded"><code># Windows
.\run-tests.bat

# The script will:
# - Check if Docker container is running
# - Execute pytest inside the container
# - Display results with verbose output
</code></pre>

                    <h3 class="mb-2 mt-4">Manual Execution (Docker)</h3>
                    <p>If you prefer to run tests manually inside the Docker container:</p>
                    <pre class="p-3 rounded"><code># Run all tests
docker exec -e PYTHONPATH=/app master-thesis-2twin2clouds-1 python -m pytest /app/tests/ -v

# Run specific test file
docker exec -e PYTHONPATH=/app master-thesis-2twin2clouds-1 python -m pytest /app/tests/test_formulas_aws.py -v

# Run tests with coverage report
docker exec -e PYTHONPATH=/app master-thesis-2twin2clouds-1 python -m pytest /app/tests/ --cov=backend --cov-report=html

# Run tests by category
docker exec -e PYTHONPATH=/app master-thesis-2twin2clouds-1 python -m pytest /app/tests/test_formulas_*.py -v
</code></pre>

                    <h3 class="mb-2 mt-4">Local Execution (Without Docker)</h3>
                    <p>If running locally with Python installed:</p>
                    <pre class="p-3 rounded"><code>cd 2-twin2clouds
pytest tests/ -v

# With coverage
pytest tests/ --cov=backend

# Specific test file
pytest tests/test_optimization.py -v
</code></pre>

                    <div class="alert alert-info mt-4">
                        <i class="fa-solid fa-circle-info me-2"></i>
                        <strong>Note:</strong> The test suite is designed to run in the Docker environment to ensure
                        consistency.
                        Make sure the container is running before executing tests:
                        <pre class="p-2 rounded mt-2"><code>docker-compose up -d</code></pre>
                    </div>
                </div>
            </div>

            <!-- Test Organization -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-folder-tree me-2"></i>Test Organization</h2>
                    <p>Tests are organized by functional area in the <code>tests/</code> directory:</p>
                    <div class="table-responsive">
                        <pre class="p-3 rounded"><code>tests/
├── test_formulas_aws.py               # AWS cost formula verification
├── test_formulas_azure.py             # Azure cost formula verification
├── test_formulas_gcp.py               # GCP cost formula verification
├── test_transfer.py                   # Data transfer cost verification
├── test_l4_glue_code.py               # Cross-cloud glue code logic
├── test_optimization.py               # Decision graph and path optimization
├── test_calculate_pricing_refactored.py # Dynamic pricing integration tests
├── test_rest_api_endpoints.py         # General API endpoint tests (File Age, Currency)
├── test_rest_api_regions.py           # Region fetching endpoint tests
├── test_pricing_validation.py         # JSON schema validation
├── test_utils_file_age.py             # File age utility tests
└── test_integration.py                # End-to-end orchestration
</code></pre>
                    </div>

                    <h3 class="h5 mt-4">Test Naming Conventions</h3>
                    <ul>
                        <li><code>test_formulas_*.py</code> - Cost calculation formula tests</li>
                        <li><code>test_transfer.py</code> - Data transfer logic tests</li>
                        <li><code>test_l4_glue_code.py</code> - L4 cross-cloud glue code tests</li>
                        <li><code>test_calculate_pricing_refactored.py</code> - Dynamic pricing integration tests</li>
                        <li><code>test_pricing_validation.py</code> - Output schema validation tests</li>
                        <li><code>test_optimization.py</code> - Algorithm and decision logic tests</li>
                        <li><code>test_rest_api_endpoints.py</code> - General API endpoint tests</li>
                    </ul>
                </div>
            </div>

            <!-- Writing New Tests -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-code me-2"></i>Writing New Tests</h2>

                    <h3 class="h5">Test Structure</h3>
                    <p>All tests follow the <strong>Arrange-Act-Assert</strong> pattern:</p>
                    <pre class="p-3 rounded"><code>import pytest
from backend.calculation.aws import calculate_aws_iot_cost

def test_aws_iot_custom_scenario():
    """Test AWS IoT cost calculation for a custom scenario"""
    
    # Arrange - Set up test data
    params = {
        "devices": 1000,
        "messageIntervalMinutes": 10,
        "messageSizeKB": 0.5,
        "storageDurationMonths": 12
    }
    prices = {
        "pricePerMessage": 0.000001,
        "pricePerDeviceAndMonth": 0
    }
    
    # Act - Execute the function
    result = calculate_aws_iot_cost(params, prices)
    
    # Assert - Verify the results
    assert result["totalCost"] > 0
    assert "breakdown" in result
    assert result["messagesPerMonth"] == 4_320_000
</code></pre>

                    <h3 class="h5 mt-4">Best Practices</h3>
                    <ul>
                        <li><strong>Descriptive Names:</strong> Test names should clearly describe what is being tested
                        </li>
                        <li><strong>Single Responsibility:</strong> Each test should verify one specific behavior</li>
                        <li><strong>Mock External Dependencies:</strong> Use <code>unittest.mock.patch</code> for API
                            calls
                        </li>
                        <li><strong>Test Edge Cases:</strong> Include tests for zero values, extremes, and error
                            conditions
                        </li>
                        <li><strong>Independence:</strong> Tests should be runnable in any order without dependencies
                        </li>
                        <li><strong>Clear Assertions:</strong> Use specific assert statements with meaningful failure
                            messages</li>
                    </ul>
                </div>
            </div>

            <!-- CI/CD Integration -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-gears me-2"></i>Continuous Integration</h2>
                    <p>The test suite is designed for easy integration into CI/CD pipelines:</p>

                    <h3 class="h5">GitHub Actions Example</h3>
                    <pre class="p-3 rounded"><code>name: Test Suite

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Start Docker containers
        run: docker-compose up -d
      
      - name: Run tests
        run: |
          docker exec master-thesis-2twin2clouds-1 \
            python -m pytest /app/tests/ -v --junitxml=test-results.xml
      
      - name: Publish test results
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: test-results.xml
</code></pre>

                    <h3 class="h5 mt-4">Jenkins Example</h3>
                    <pre class="p-3 rounded"><code>pipeline {
    agent any
    
    stages {
        stage('Test') {
            steps {
                sh 'docker-compose up -d'
                sh '''
                    docker exec master-thesis-2twin2clouds-1 \
                    python -m pytest /app/tests/ -v
                '''
            }
        }
    }
    
    post {
        always {
            sh 'docker-compose down'
        }
    }
}
</code></pre>
                </div>
            </div>

            <!-- Troubleshooting -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-triangle-exclamation me-2"></i>Troubleshooting</h2>

                    <h3 class="h5">Container Not Running</h3>
                    <p><strong>Error:</strong> "Docker container is not running!"</p>
                    <p><strong>Solution:</strong> Start the container first:</p>
                    <pre class="p-3 rounded"><code>docker-compose up -d</code></pre>

                    <h3 class="h5 mt-4">Module Import Errors</h3>
                    <p><strong>Error:</strong> "ModuleNotFoundError" or import failures</p>
                    <p><strong>Solution:</strong> Ensure <code>PYTHONPATH</code> is set correctly:</p>
                    <pre
                        class="p-3 rounded"><code>docker exec -e PYTHONPATH=/app master-thesis-2twin2clouds-1 python -m pytest /app/tests/ -v</code></pre>

                    <h3 class="h5 mt-4">Missing Dependencies</h3>
                    <p><strong>Error:</strong> "No module named 'pytest'" or similar</p>
                    <p><strong>Solution:</strong> Rebuild the Docker container:</p>
                    <pre class="p-3 rounded"><code>docker-compose down
docker-compose build --no-cache
docker-compose up -d</code></pre>

                    <h3 class="h5 mt-4">Test Failures Due to File Paths</h3>
                    <p><strong>Issue:</strong> Tests fail with file not found errors</p>
                    <p><strong>Solution:</strong> Ensure you're using container paths (<code>/app/</code>) not local
                        paths
                        when running in Docker.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <script src="../js/docs-nav.js" defer></script>
</body>

</html>