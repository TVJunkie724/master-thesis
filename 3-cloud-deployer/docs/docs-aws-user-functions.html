<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>AWS User Functions — Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-brands fa-aws me-2"></i> AWS User Functions (Processors)
            </h1>

            <p class="text-muted mb-4">
                Architecture, packaging, and data flow guide for user-defined processor functions on AWS.
            </p>

            <div class="callout info mb-4">
                <strong><i class="fa-solid fa-check-circle me-2"></i>Status: Active</strong>
                Standard "Decoupled Invoke" pattern using Lambda SDK.
            </div>

            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list me-2"></i>Table of Contents</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><a href="#high-level-architecture">High-Level Architecture</a></li>
                                <li><a href="#naming-discovery">Naming & Discovery</a></li>
                                <li><a href="#packaging-bundling">Packaging & Bundling</a></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li><a href="#security-iam">Security & IAM</a></li>
                                <li><a href="#development-flow">Development Flow</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4" id="high-level-architecture">
                <h2 class="mb-3"><i class="fa-solid fa-sitemap me-2"></i>High-Level Architecture</h2>
                <p>The AWS implementation uses a <strong>Decoupled Invoke Pattern</strong> where the infrastructure
                    wrapper invokes the user-defined logic via the AWS Lambda SDK.</p>

                <div class="card bg-dark text-white mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Flow Diagram</h5>
                        <div class="mermaid-diagram text-center">
                            Dispatcher [L1 Dispatcher] (→ Connector [L0] → Ingestion [L0]) → Wrapper [L2 Processor
                            Wrapper] <br>
                            ↓ <br>
                            User Processor [Twin-Device-Processor] (Sync SDK Invoke) <br>
                            ↓ <br>
                            Wrapper → Persister [L2 Persister] → DynamoDB [L3 Hot Storage]
                        </div>
                    </div>
                </div>

                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Resource Name</th>
                            <th>Type</th>
                            <th>Role</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Wrapper</strong></td>
                            <td><code>{twin}-processor</code></td>
                            <td>Lambda</td>
                            <td>Infrastructure code. Routes events to specific user processors.</td>
                        </tr>
                        <tr>
                            <td><strong>User Processor</strong></td>
                            <td><code>{twin}-{device}-processor</code></td>
                            <td>Lambda</td>
                            <td>User code. Processes telemetry for a specific device.</td>
                        </tr>
                        <tr>
                            <td><strong>Persister</strong></td>
                            <td><code>{twin}-l2-persister</code></td>
                            <td>Lambda</td>
                            <td>Infrastructure code. Writes processed data to storage.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card mb-4" id="naming-discovery">
                <h2 class="mb-3"><i class="fa-solid fa-magnifying-glass me-2"></i>Naming & Discovery</h2>
                <ul>
                    <li><strong>Naming Pattern:</strong> <code>{twin_name}-{device_id}-processor</code></li>
                    <li><strong>Discovery:</strong> The Wrapper constructs the target function name dynamically at
                        runtime
                        using the <code>device_id</code> from the incoming event.</li>
                    <li><strong>Invocation:</strong> Uses <code>boto3.client('lambda').invoke()</code> with
                        <code>InvocationType='RequestResponse'</code> (Synchronous).
                    </li>
                </ul>

                <h5 class="mt-3">Code Reference</h5>
                <p><code>src/providers/aws/lambda_functions/processor_wrapper/lambda_function.py</code></p>
                <div class="bg-dark text-white p-3 rounded">
                    <pre><code>def _get_processor_lambda_name(device_id: str) -> str:
    twin_name = _get_digital_twin_info()["config"]["digital_twin_name"]
    return f"{twin_name}-{device_id}-processor"</code></pre>
                </div>
            </div>

            <div class="card mb-4" id="packaging-bundling">
                <h2 class="mb-3"><i class="fa-solid fa-box-open me-2"></i>Packaging & Bundling</h2>
                <p>The bundling process is handled by <code>src/providers/terraform/package_builder.py</code>.</p>

                <h5 class="mt-3">Build Process</h5>
                <ol>
                    <li><strong>Iterate Devices:</strong> Reads <code>config_iot_devices.json</code> to find all defined
                        devices.</li>
                    <li><strong>Locate Code:</strong> Looks for user code in
                        <code>upload/{project}/aws/lambda_functions/processors/{device_id}/</code>.
                    </li>
                    <li><strong>Build ZIP:</strong> Creates an individual ZIP file for <strong>each</strong> device
                        processor.
                        <ul>
                            <li>File: <code>.build/aws/processor-{device_id}.zip</code></li>
                            <li>Contents: User's <code>lambda_function.py</code> + <code>_shared/</code> modules.</li>
                        </ul>
                    </li>
                    <li><strong>TfVars Generation:</strong> <code>tfvars_generator.py</code> creates a list variable
                        <code>aws_processors</code> containing <code>{name, zip_path}</code> objects.
                    </li>
                </ol>

                <h5 class="mt-3">Terraform Deployment</h5>
                <p><code>src/terraform/aws_compute.tf</code> iterates over this list to create resources:</p>
                <div class="bg-dark text-white p-3 rounded">
                    <pre><code>resource "aws_lambda_function" "user_processor" {
  for_each = { for p in var.aws_processors : p.name => p }
  function_name = "${var.digital_twin_name}-${each.value.name}-processor"
  ...
}</code></pre>
                </div>
            </div>

            <div class="card mb-4" id="security-iam">
                <h2 class="mb-3"><i class="fa-solid fa-lock me-2"></i>Security & IAM</h2>
                <p>To allow the Wrapper to call the dynamically named User Functions, a specific IAM policy is applied.
                </p>
                <ul>
                    <li><strong>Role:</strong> <code>l2_lambda</code> (Shared by Wrapper and Persister)</li>
                    <li><strong>Policy:</strong> <code>l2_invoke_lambda</code></li>
                    <li><strong>Resource:</strong>
                        <code>arn:aws:lambda:{region}:{account}:function:{twin}-*</code>
                    </li>
                    <li><strong>Action:</strong> <code>lambda:InvokeFunction</code></li>
                </ul>
                <p>This allows the wrapper to invoke any function associated with the current Digital Twin deployment.
                </p>
            </div>

            <div class="card mb-4" id="development-flow">
                <h2 class="mb-3"><i class="fa-solid fa-code me-2"></i>Development Flow</h2>
                <ol>
                    <li><strong>Create Processor:</strong> User creates a folder <code>processors/{device_id}</code>.
                    </li>
                    <li><strong>Add Code:</strong> User adds <code>lambda_function.py</code> with
                        <code>def lambda_handler(event, context): ...</code>.
                    </li>
                    <li><strong>Deploy:</strong>
                        <ul>
                            <li><code>package_builder.py</code> zips the code.</li>
                            <li>Terraform creates the new Lambda resource.</li>
                            <li>IAM role automatically allows the Wrapper to call it.</li>
                        </ul>
                    </li>
                </ol>
            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/docs-nav.js"></script>
</body>

</html>