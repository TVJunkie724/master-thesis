<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>REST API Reference â€” Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-solid fa-code me-2"></i> REST API Reference
            </h1>

            <p class="text-muted mb-4">
                Complete reference for all REST API endpoints provided by the Digital Twin Deployer.
            </p>

            <div class="callout info mb-4">
                <strong><i class="fa-solid fa-lightbulb me-2"></i>Interactive Documentation</strong>
                Access interactive Swagger UI at <code><a href="/docs">/docs</a></code> or ReDoc at
                <code><a href="/redoc">/redoc</a></code>
            </div>

            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list me-2"></i>Table of Contents</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><a href="#deployment">Deployment Endpoints</a></li>
                                <li><a href="#status">Status/Info Endpoints</a></li>
                                <li><a href="#lambda">AWS Lambda Management</a></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li><a href="#projects">Projects Endpoints</a></li>
                                <li><a href="#credentials">Credential Validation</a></li>
                                <li><a href="#errors">Error Responses</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deployment Endpoints -->
            <div class="card mb-4" id="deployment">
                <h2 class="mb-3"><i class="fa-solid fa-rocket me-2"></i>Deployment Endpoints</h2>

                <h3 class="mt-4">POST /deploy</h3>
                <p>Deploy the entire digital twin environment (all layers).</p>
                <p><strong>Query Parameters:</strong></p>
                <ul>
                    <li><code>provider</code> (string): Cloud provider - <code>"aws"</code>, <code>"azure"</code>, or
                        <code>"google"</code>. Default: <code>"aws"</code>
                    </li>
                </ul>
                <p><strong>Example:</strong></p>
                <pre class="p-3 rounded"><code>POST /deploy?provider=aws</code></pre>
                <p><strong>Response:</strong></p>
                <pre class="p-3 rounded"><code>{
  "message": "Core and IoT services deployed successfully"
}</code></pre>

                <h3 class="mt-4">POST /deploy_l1</h3>
                <p>Deploy Layer 1 (IoT Dispatcher Layer).</p>
                <p><strong>Actions:</strong></p>
                <ul>
                    <li>Creates IAM role for dispatcher Lambda</li>
                    <li>Deploys dispatcher Lambda function</li>
                    <li>Configures IoT topic rule</li>
                </ul>

                <h3 class="mt-4">POST /deploy_l2</h3>
                <p>Deploy Layer 2 (Persister/Processor Layer).</p>
                <p><strong>Actions:</strong></p>
                <ul>
                    <li>Creates IAM roles for persister and processors</li>
                    <li>Deploys persister Lambda function</li>
                    <li>Deploys processor Lambda functions for each IoT device</li>
                </ul>

                <h3 class="mt-4">POST /deploy_l3</h3>
                <p>Deploy Layer 3 (Hot, Cool, Archive Storage).</p>
                <p><strong>Actions:</strong></p>
                <ul>
                    <li><strong>Hot:</strong> DynamoDB table, hot-to-cold mover Lambda, EventBridge schedule</li>
                    <li><strong>Cool:</strong> S3 bucket, cold-to-archive mover Lambda, EventBridge schedule</li>
                    <li><strong>Archive:</strong> S3 Glacier bucket</li>
                </ul>

                <h3 class="mt-4">POST /deploy_l4</h3>
                <p>Deploy Layer 4 (TwinMaker Layer).</p>
                <p><strong>Actions:</strong></p>
                <ul>
                    <li>Creates S3 bucket for TwinMaker assets</li>
                    <li>Creates IAM role for TwinMaker workspace</li>
                    <li>Creates TwinMaker workspace</li>
                    <li>Creates Lambda connector for TwinMaker</li>
                </ul>

                <h3 class="mt-4">POST /deploy_l5</h3>
                <p>Deploy Layer 5 (Grafana/Visualization Layer).</p>
                <p><strong>Actions:</strong></p>
                <ul>
                    <li>Creates IAM role for Grafana</li>
                    <li>Creates Grafana workspace</li>
                    <li>Configures CORS for TwinMaker S3 bucket</li>
                </ul>

                <h3 class="mt-4">POST /destroy</h3>
                <p>Destroy the entire digital twin environment.</p>
                <p><strong>Warning:</strong> This deletes all resources and data. Use with caution!</p>
                <pre class="p-3 rounded"><code>POST /destroy?provider=aws</code></pre>

                <h3 class="mt-4">POST /destroy_l{1-5}</h3>
                <p>Destroy resources by specific layer.</p>
                <ul>
                    <li><code>POST /destroy_l1</code> - Destroy L1</li>
                    <li><code>POST /destroy_l2</code> - Destroy L2</li>
                    <li><code>POST /destroy_l3</code> - Destroy L3</li>
                    <li><code>POST /destroy_l4</code> - Destroy L4</li>
                    <li><code>POST /destroy_l5</code> - Destroy L5</li>
                </ul>
                <p><strong>Example:</strong></p>
                <pre class="p-3 rounded"><code>POST /destroy_l1?provider=aws</code></pre>

                <h3 class="mt-4">POST /recreate_updated_events</h3>
                <p>Redeploy Event Actions (L2 -> L2) and Event Checker (L2) to update logic efficiently.</p>
                <p><strong>Usage:</strong></p>
                <pre class="p-3 rounded"><code>POST /recreate_updated_events?provider=aws</code></pre>
            </div>

            <!-- Status Endpoints -->
            <div class="card mb-4" id="status">
                <h2 class="mb-3"><i class="fa-solid fa-info-circle me-2"></i>Status/Info Endpoints</h2>

                <h3 class="mt-4">GET /check</h3>
                <p>Check deployment status of all layers.</p>
                <p><strong>Query Parameters:</strong></p>
                <ul>
                    <li><code>provider</code> (string): Cloud provider to check. Default: <code>"aws"</code></li>
                </ul>
                <p><strong>Example:</strong></p>
                <pre class="p-3 rounded"><code>GET /check?provider=aws</code></pre>
                <p><strong>Note:</strong> Status is printed to server logs.</p>

                <h3 class="mt-4">GET /check_l{1-5}</h3>
                <p>Check individual layer status.</p>
                <ul>
                    <li><code>GET /check_l1</code> - Check Layer 1 (IoT Dispatcher)</li>
                    <li><code>GET /check_l2</code> - Check Layer 2 (Persister/Processor)</li>
                    <li><code>GET /check_l3</code> - Check Layer 3 (Storage)</li>
                    <li><code>GET /check_l4</code> - Check Layer 4 (TwinMaker)</li>
                    <li><code>GET /check_l5</code> - Check Layer 5 (Grafana)</li>
                </ul>

                <h3 class="mt-4">GET /info/config</h3>
                <p>Retrieve main digital twin configuration.</p>
                <p><strong>Response Example:</strong></p>
                <pre class="p-3 rounded"><code>{
  "digital_twin_name": "dt",
  "layer_3_hot_to_cold_interval_days": 30,
  "layer_3_cold_to_archive_interval_days": 90
}</code></pre>

                <h3 class="mt-4">GET /info/config_iot_devices</h3>
                <p>Retrieve IoT device configuration.</p>
                <p><strong>Response Example:</strong></p>
                <pre class="p-3 rounded"><code>[
  {
    "id": "temperature-sensor-1",
    "properties": [
      { "name": "temperature", "dataType": "DOUBLE" }
    ]
  }
]</code></pre>

                <h3 class="mt-4">GET /info/config_providers</h3>
                <p>Retrieve cloud provider mapping per layer.</p>
                <p><strong>Response Example:</strong></p>
                <pre class="p-3 rounded"><code>{
  "layer_1_provider": "aws",
  "layer_2_provider": "aws",
  "layer_3_hot_provider": "aws",
  "layer_3_cold_provider": "aws",
  "layer_3_archive_provider": "aws",
  "layer_4_provider": "aws",
  "layer_5_provider": "aws"
}</code></pre>

                <h3 class="mt-4">GET /info/config_hierarchy</h3>
                <p>Retrieve TwinMaker entity hierarchy configuration.</p>

                <h3 class="mt-4">GET /info/config_events</h3>
                <p>Retrieve event-driven automation configuration.</p>
            </div>

            <!-- AWS Lambda Management -->
            <div class="card mb-4" id="lambda">
                <h2 class="mb-3"><i class="fa-brands fa-aws me-2"></i>AWS Lambda Management</h2>

                <h3 class="mt-4">POST /lambda_update</h3>
                <p>Update an AWS Lambda function with latest local code.</p>
                <p><strong>Request Body:</strong></p>
                <pre class="p-3 rounded"><code>{
  "local_function_name": "dispatcher",
  "environment": {
    "Variables": {
      "ENV_VAR": "value"
    }
  }
}</code></pre>
                <p><strong>Special Cases:</strong></p>
                <ul>
                    <li>If <code>local_function_name</code> is <code>"default-processor"</code>, updates all processor
                        Lambdas</li>
                    <li><code>environment</code> parameter is optional</li>
                </ul>

                <h3 class="mt-4">GET /lambda_logs</h3>
                <p>Fetch recent Lambda function logs.</p>
                <p><strong>Query Parameters:</strong></p>
                <ul>
                    <li><code>local_function_name</code> (string, required): Name of Lambda function</li>
                    <li><code>n</code> (integer, optional): Number of log lines. Default: 10</li>
                    <li><code>filter_system_logs</code> (boolean, optional): Exclude AWS system logs. Default: true</li>
                </ul>
                <p><strong>Example:</strong></p>
                <pre
                    class="p-3 rounded"><code>GET /lambda_logs?local_function_name=dispatcher&n=20&filter_system_logs=true</code></pre>
                <p><strong>Response:</strong> Array of log message strings</p>

                <h3 class="mt-4">POST /lambda_invoke</h3>
                <p>Invoke a Lambda function with a custom payload.</p>
                <p><strong>Request Body (LambdaInvokeRequest):</strong></p>
                <pre class="p-3 rounded"><code>{
  "local_function_name": "dispatcher",
  "payload": { "key": "value" },
  "sync": true
}</code></pre>
                <p><strong>Parameters:</strong></p>
                <ul>
                    <li><code>local_function_name</code>: Name of the function (e.g., "dispatcher")</li>
                    <li><code>payload</code>: JSON payload to send</li>
                    <li><code>sync</code>: <code>true</code> for RequestResponse, <code>false</code> for Event (async)
                    </li>
                </ul>
            </div>

            <!-- Projects Endpoints -->
            <div class="card mb-4" id="projects">
                <h2 class="mb-3"><i class="fa-solid fa-folder me-2"></i>Projects Endpoints</h2>

                <h3 class="mt-4">GET /projects</h3>
                <p>List all available projects.</p>

                <h3 class="mt-4">POST /projects</h3>
                <p>Create new project from uploaded zip file.</p>
                <p><strong>Request Body:</strong> <code>multipart/form-data</code> with <code>file</code> and
                    <code>project_name</code>
                </p>

                <h3 class="mt-4">PUT /projects/{project_name}/activate</h3>
                <p>Switch active project context.</p>

                <h3 class="mt-4">GET /projects/{project_name}/validate</h3>
                <p>Validate project structure and configuration files.</p>

                <h3 class="mt-4">PUT /projects/{project_name}/config/{config_type}</h3>
                <p>Update specific config file. Config types: <code>config</code>, <code>iot</code>,
                    <code>events</code>, <code>hierarchy</code>, <code>credentials</code>, <code>providers</code>,
                    <code>optimization</code>
                </p>
            </div>

            <!-- Credential Validation Endpoints -->
            <div class="card mb-4" id="credentials">
                <h2 class="mb-3"><i class="fa-solid fa-key me-2"></i>Credential Validation Endpoints</h2>

                <div class="callout info mb-3">
                    <strong><i class="fa-solid fa-lightbulb me-2"></i>Pre-Deployment Check</strong>
                    Use these endpoints to verify your cloud credentials have all required permissions before deploying.
                </div>

                <h3 class="mt-4">POST /credentials/check/aws</h3>
                <p>Validate AWS credentials provided in the request body against all required deployment permissions.
                </p>
                <p><strong>Request Body:</strong></p>
                <pre class="p-3 rounded"><code>{
  "aws_access_key_id": "AKIAIOSFODNN7EXAMPLE",
  "aws_secret_access_key": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
  "aws_region": "eu-central-1",
  "aws_session_token": "optional-session-token"
}</code></pre>
                <p><strong>Response:</strong></p>
                <pre class="p-3 rounded"><code>{
  "status": "valid",
  "message": "All required permissions are present.",
  "caller_identity": {
    "account": "123456789012",
    "arn": "arn:aws:iam::123456789012:user/deployer",
    "user_id": "AIDAEXAMPLE"
  },
  "can_list_policies": true,
  "by_layer": {
    "layer_1": { "status": "valid", "services": {...} },
    "layer_2": { "status": "valid", "services": {...} },
    ...
  },
  "by_service": {
    "iam": { "valid": [...], "missing": [], "used_in_layers": ["layer_1", "layer_2"] },
    ...
  },
  "summary": {
    "total_required": 75,
    "valid": 75,
    "missing": 0
  }
}</code></pre>

                <h3 class="mt-4">GET /credentials/check/aws</h3>
                <p>Validate AWS credentials from the project's <code>config_credentials.json</code> file.</p>
                <p><strong>Query Parameters:</strong></p>
                <ul>
                    <li><code>project</code> (string, optional): Project name to load credentials from. Uses active
                        project if not specified.</li>
                </ul>
                <p><strong>Example:</strong></p>
                <pre class="p-3 rounded"><code>GET /credentials/check/aws?project=my-twin-project</code></pre>

                <h4 class="mt-4">Response Status Values</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>valid</code></td>
                            <td>All required permissions are present</td>
                        </tr>
                        <tr>
                            <td><code>partial</code></td>
                            <td>Some permissions are missing</td>
                        </tr>
                        <tr>
                            <td><code>invalid</code></td>
                            <td>No required permissions are present or credentials are invalid</td>
                        </tr>
                        <tr>
                            <td><code>check_failed</code></td>
                            <td>Cannot check permissions (credentials lack access to list their own policies)</td>
                        </tr>
                        <tr>
                            <td><code>error</code></td>
                            <td>Configuration or system error</td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <!-- Validation Endpoints -->
            <div class="card mb-4">
                <h2 class="mb-3"><i class="fa-solid fa-check-double me-2"></i>Validation Endpoints</h2>

                <h3 class="mt-4">POST /validate/zip</h3>
                <p>Validate project zip file structure and contents.</p>

                <h3 class="mt-4">POST /validate/config/{config_type}</h3>
                <p>Validate specific configuration file content.</p>

                <h3 class="mt-4">POST /validate/state-machine</h3>
                <p>Validate Step Functions state machine definition.</p>

                <h3 class="mt-4">POST /validate/function-code</h3>
                <p>Validate Lambda function code by provider (aws/azure/google).</p>
            </div>

            <!-- Error Responses -->
            <div class="card mb-4" id="errors">
                <h2 class="mb-3"><i class="fa-solid fa-exclamation-triangle me-2"></i>Error Responses</h2>
                <p>All endpoints return standard HTTP error codes:</p>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Meaning</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>200</td>
                            <td>OK</td>
                            <td>Request succeeded</td>
                        </tr>
                        <tr>
                            <td>400</td>
                            <td>Bad Request</td>
                            <td>Invalid parameters or provider</td>
                        </tr>
                        <tr>
                            <td>409</td>
                            <td>Conflict</td>
                            <td>Project name doesn't match active project (safety check)</td>
                        </tr>
                        <tr>
                            <td>500</td>
                            <td>Internal Server Error</td>
                            <td>Deployment/cloud provider error. Check logs for details.</td>
                        </tr>
                    </tbody>
                </table>

                <p class="mt-3"><strong>Error Response Format:</strong></p>
                <pre class="p-3 rounded"><code>{
  "detail": "Error message with stack trace"
}</code></pre>
            </div>

            <!-- Base URL -->
            <div class="card mb-4">
                <h2 class="mb-3"><i class="fa-solid fa-link me-2"></i>Base URL</h2>
                <p>Default API base URL: <code>http://localhost:8000</code></p>
                <p>You can change the port in <code>Dockerfile</code> or when running uvicorn:</p>
                <pre class="p-3 rounded"><code>uvicorn rest_api:app --host 0.0.0.0 --port 8001</code></pre>
            </div>

        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <script src="js/docs-nav.js" defer></script>
</body>

</html>