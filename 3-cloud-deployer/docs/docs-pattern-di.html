<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Dependency Injection — Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>
    <div class="layout">
        <aside id="nav-placeholder"></aside>
        <main class="p-4">
            <h1 class="mb-3"><i class="fa-solid fa-syringe me-2"></i>Dependency Injection (Context)</h1>
            <p class="text-muted mb-4">Explicit dependency passing via DeploymentContext.</p>

            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="docs-design-patterns.html">Design Patterns</a></li>
                    <li class="breadcrumb-item active">Dependency Injection</li>
                </ol>
            </nav>

            <div class="card mb-4">
                <h2 class="mb-3">Definition</h2>
                <p>Dependency Injection is a technique where objects receive their dependencies from external
                    sources rather than creating them internally.</p>

                <h4 class="mt-4">Why We Use It</h4>
                <p>The old code used global variables (<code>globals.py</code>) which made testing difficult
                    and hid dependencies. The DeploymentContext makes all dependencies explicit.</p>
            </div>

            <div class="card mb-4">
                <h2 class="mb-3">Before vs After</h2>
                <pre class="p-3 rounded bg-dark text-light"><code>BEFORE: Global State (Hidden Dependencies)
──────────────────────────────────────────────────────────────────────────────
┌─────────────────────┐
│    deploy_l1()      │
│                     │
│ import globals ─────┼────► globals.py (HIDDEN)
│ import globals_aws ─┼────► globals_aws.py     
└─────────────────────┘

      ❌ Dependencies hidden via imports
      ❌ Hard to test (must mock modules)
      ❌ No isolation between requests


AFTER: Dependency Injection (Explicit Dependencies)
──────────────────────────────────────────────────────────────────────────────
                       ┌─────────────────────────────────┐
                       │      DeploymentContext          │
                       │  ┌───────────────────────────┐  │
                       │  │ - config: ProjectConfig   │  │
                       │  │ - providers: Dict[str, P] │  │
                       │  │ - project_path: Path      │  │
                       │  └───────────────────────────┘  │
                       └───────────────┬─────────────────┘
                                       │ passed to
              ┌────────────────────────┼────────────────────────┐
              ▼                        ▼                        ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│ deploy_l1(context)  │  │ deploy_l2(context)  │  │ deploy_l3(context)  │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘

      ✅ Dependencies explicit in signature
      ✅ Easy to test (just pass mock context)
      ✅ Each request gets isolated context</code></pre>
            </div>

            <div class="card mb-4">
                <h2 class="mb-3">Code Comparison</h2>
                <h5>Before (Global State)</h5>
                <pre class="p-3 rounded"><code># Old approach - hidden dependencies
import globals

def deploy_l1():
    twin_name = globals.config["digital_twin_name"]  # Hidden!
    client = globals_aws.get_iam_client()  # Hidden!
    ...</code></pre>

                <h5 class="mt-4">After (Dependency Injection)</h5>
                <pre class="p-3 rounded"><code># New approach - explicit dependencies
def deploy_l1(context: DeploymentContext) -> None:
    twin_name = context.config.digital_twin_name  # Explicit!
    provider = context.get_provider_for_layer(1)  # Explicit!
    client = provider.clients["iam"]  # Explicit!
    ...</code></pre>
            </div>

            <div class="card mb-4">
                <h2 class="mb-3">Implementation</h2>
                <pre class="p-3 rounded"><code># File: src/core/context.py

@dataclass
class DeploymentContext:
    """Encapsulates all state needed for deployment."""
    
    project_name: str
    project_path: Path
    config: ProjectConfig
    providers: Dict[str, CloudProvider] = field(default_factory=dict)
    credentials: Dict[str, dict] = field(default_factory=dict)
    
    def get_provider_for_layer(self, layer: int) -> CloudProvider:
        """Get the provider configured for a specific layer."""
        provider_name = self.config.get_provider_for_layer(layer)
        return self.providers[provider_name]</code></pre>
            </div>

            <div class="card mb-4">
                <h2 class="mb-3">Benefits</h2>
                <ul>
                    <li><strong>Testability:</strong> Easy to mock configuration and providers</li>
                    <li><strong>Clarity:</strong> All dependencies are visible in function signatures</li>
                    <li><strong>Concurrency:</strong> Multiple deployments can run with different configs</li>
                    <li><strong>Debugging:</strong> State is traceable, not scattered across globals</li>
                </ul>
            </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;"><i class="fa-solid fa-arrow-up"></i></button>
    <script src="js/docs-nav.js" defer></script>
</body>

</html>