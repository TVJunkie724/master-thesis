<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Cloud Credentials Setup — Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-solid fa-key me-2"></i> Cloud Credentials Setup
            </h1>

            <p class="text-muted mb-4">
                Configure cloud provider credentials and permissions required for deploying your Digital Twin
                infrastructure.
            </p>

            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list me-2"></i>Table of Contents</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><a href="#overview">Overview</a></li>
                                <li><a href="#aws-setup">AWS Setup</a></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li><a href="#azure-setup">Azure Setup</a></li>
                                <li><a href="#gcp-setup">GCP Setup</a> <span class="badge bg-secondary">Coming
                                        Soon</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overview -->
            <div class="card mb-4" id="overview">
                <h2 class="mb-3"><i class="fa-solid fa-circle-info me-2"></i>Overview</h2>

                <p>The Multi-Cloud Digital Twin Deployer requires specific permissions on each cloud provider to create,
                    manage, and destroy infrastructure resources. This guide walks you through setting up the required
                    credentials and permissions for each supported cloud provider.</p>

                <div class="callout info">
                    <strong><i class="fa-solid fa-lightbulb me-2"></i>Principle of Least Privilege</strong>
                    We provide ready-to-use policy documents containing only the permissions required by the deployer.
                    For development, you can use broader admin policies, but for production we recommend using these
                    minimal policies.
                </div>

                <h4 class="mt-4">Credential Storage</h4>
                <p>All credentials are stored in your project's <code>config_credentials.json</code> file:</p>
                <pre class="p-3 rounded"><code>{
  "aws": {
    "aws_access_key_id": "YOUR_ACCESS_KEY",
    "aws_secret_access_key": "YOUR_SECRET_KEY",
    "aws_region": "eu-central-1"
  },
  "azure": { ... },
  "google": { ... }
}</code></pre>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Security Warning</strong>
                    Never commit <code>config_credentials.json</code> to version control! This file is in
                    <code>.gitignore</code>.
                </div>
            </div>

            <!-- AWS Setup -->
            <div class="card mb-4" id="aws-setup">
                <h2 class="mb-3"><i class="fa-brands fa-aws me-2"></i>AWS Setup</h2>

                <h4>Step 1: Create an IAM User</h4>
                <ol>
                    <li>Sign in to the <a href="https://console.aws.amazon.com/iam/" target="_blank">AWS IAM Console</a>
                    </li>
                    <li>Navigate to <strong>Users</strong> → <strong>Create user</strong></li>
                    <li>Enter a username (e.g., <code>digital-twin-deployer</code>)</li>
                    <li>Select <strong>Attach policies directly</strong></li>
                    <li>Attach the custom policy (see Step 2) or use <code>AdministratorAccess</code> for development
                    </li>
                    <li>Complete the wizard and save the <strong>Access Key ID</strong> and <strong>Secret Access
                            Key</strong></li>
                </ol>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-shield-halved me-2"></i>AWS Best Practice</strong>
                    For production, create a dedicated IAM user with only the required permissions.
                    Avoid using root account credentials.
                </div>

                <h4 class="mt-4">Step 2: Create Custom IAM Policy</h4>
                <p>Instead of granting full <code>AdministratorAccess</code>, create a custom policy with minimal
                    required permissions:</p>

                <ol>
                    <li>Navigate to <strong>Policies</strong> → <strong>Create policy</strong></li>
                    <li>Select the <strong>JSON</strong> tab</li>
                    <li>Copy the policy document from: <a href="references/aws_deployer_policy.json" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fa-solid fa-download me-1"></i>aws_deployer_policy.json
                        </a></li>
                    <li>Paste into the JSON editor and click <strong>Next</strong></li>
                    <li>Name the policy (e.g., <code>DigitalTwinDeployerPolicy</code>)</li>
                    <li>Click <strong>Create policy</strong></li>
                </ol>

                <h5 class="mt-3">Policy Summary</h5>
                <p>The policy includes permissions for:</p>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Layer</th>
                            <th>Services</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge text-bg-warning">L0</span></td>
                            <td>IAM, Lambda</td>
                            <td>Multi-cloud HTTP receivers (Ingestion, Writers, Readers)</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L1</span></td>
                            <td>IAM, Lambda, IoT Core, STS</td>
                            <td>IoT Dispatcher, Thing registration, Topic rules</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L2</span></td>
                            <td>IAM, Lambda, Step Functions</td>
                            <td>Persister, Event processing, State machines</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L3</span></td>
                            <td>DynamoDB, S3, EventBridge, Lambda</td>
                            <td>Hot/Cold/Archive storage, Data movers</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L4</span></td>
                            <td>IoT TwinMaker, S3, Lambda</td>
                            <td>Digital Twin workspace, Component types</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L5</span></td>
                            <td>Managed Grafana, IAM</td>
                            <td>Visualization dashboards</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-info">Check</span></td>
                            <td>IAM</td>
                            <td>Self-inspection for <code>check_credentials</code></td>
                        </tr>
                    </tbody>
                </table>


                <h5 class="mt-4">Alternative: AWS CLI (One Command)</h5>
                <p>If you have the AWS CLI configured, create the policy with a single command:</p>
                <pre class="p-3 rounded"><code># Download the policy file first, then run:
aws iam create-policy \
    --policy-name DigitalTwinDeployerPolicy \
    --policy-document file://aws_deployer_policy.json

# Then attach to your user:
aws iam attach-user-policy \
    --user-name digital-twin-deployer \
    --policy-arn arn:aws:iam::YOUR_ACCOUNT_ID:policy/DigitalTwinDeployerPolicy</code></pre>

                <h4 class="mt-4">Step 3: Generate Access Keys</h4>

                <ol>
                    <li>Select your IAM user → <strong>Security credentials</strong> tab</li>
                    <li>Under <strong>Access keys</strong>, click <strong>Create access key</strong></li>
                    <li>Select <strong>Application running outside AWS</strong></li>
                    <li>Click <strong>Create access key</strong></li>
                    <li>
                        <strong>Important:</strong> Download the <code>.csv</code> file or copy both keys immediately.
                        The secret key is only shown once!
                    </li>
                </ol>

                <h4 class="mt-4">Step 4: Configure Credentials</h4>
                <p>Add your credentials to <code>config_credentials.json</code>:</p>
                <pre class="p-3 rounded"><code>{
  "aws": {
    "aws_access_key_id": "AKIAIOSFODNN7EXAMPLE",
    "aws_secret_access_key": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
    "aws_region": "eu-central-1"
  }
}</code></pre>

                <h4 class="mt-4">Step 5: Verify Permissions</h4>
                <p>Use the deployer's built-in credential checker to verify your setup:</p>
                <pre class="p-3 rounded"><code># CLI
python main.py
>>> check_credentials aws

# REST API
POST /credentials/check/aws</code></pre>

                <p class="mt-2">
                    For the complete list of required permissions per layer, see the
                    <a href="docs-aws-deployment.html#iam-permissions">AWS Deployment Guide - IAM Permissions</a>.
                </p>
            </div>

            <!-- Azure Setup -->
            <div class="card mb-4" id="azure-setup">
                <h2 class="mb-3"><i class="fa-brands fa-microsoft me-2"></i>Azure Setup</h2>

                <h4>Step 1: Create App Registration (Service Principal)</h4>
                <ol>
                    <li>Sign in to the <a
                            href="https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/RegisteredApps"
                            target="_blank">Azure Portal - App Registrations</a></li>
                    <li>Click <strong>New registration</strong></li>
                    <li>Enter a name (e.g., <code>digital-twin-deployer</code>)</li>
                    <li>Select <strong>Accounts in this organizational directory only</strong></li>
                    <li>Click <strong>Register</strong></li>
                    <li>From the overview page, copy:
                        <ul>
                            <li><strong>Application (client) ID</strong> → <code>azure_client_id</code></li>
                            <li><strong>Directory (tenant) ID</strong> → <code>azure_tenant_id</code></li>
                        </ul>
                    </li>
                    <li>Go to <strong>Certificates & secrets</strong> → <strong>New client secret</strong></li>
                    <li>Add a description and expiry, click <strong>Add</strong></li>
                    <li>Copy the <strong>Value</strong> immediately → <code>azure_client_secret</code></li>
                </ol>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Important</strong>
                    Copy the client secret value immediately! It won't be shown again after you leave this page.
                </div>

                <h4 class="mt-4">Step 2: Create Custom Role (Recommended)</h4>
                <p>For <strong>least-privilege security</strong>, we provide a custom role definition with only the
                    permissions required by the deployer. This is more secure than using broad Contributor/Owner roles.
                </p>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>Custom Role Includes</strong>
                    <ul class="mb-0 mt-2">
                        <li><code>*/read</code> - Read access to all resources (for credential verification, status
                            checks)</li>
                        <li>Write/Delete permissions only for the specific services needed per layer</li>
                        <li>Data plane access for Azure Digital Twins</li>
                    </ul>
                </div>

                <h5 class="mt-3">Option A: Automated Setup Script</h5>
                <p>Download and run our setup script:</p>
                <ol>
                    <li>Download:
                        <a href="references/azure_custom_role.json" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fa-solid fa-download me-1"></i>azure_custom_role.json
                        </a>
                        <a href="references/setup_azure_role.sh" target="_blank"
                            class="btn btn-sm btn-outline-secondary ms-2">
                            <i class="fa-solid fa-download me-1"></i>setup_azure_role.sh
                        </a>
                    </li>
                    <li>Find your Service Principal Object ID:
                        <pre
                            class="p-2 rounded mt-2"><code>az ad sp show --id &lt;your_client_id&gt; --query id -o tsv</code></pre>
                    </li>
                    <li>Run the setup script:
                        <pre class="p-2 rounded mt-2"><code>chmod +x setup_azure_role.sh
./setup_azure_role.sh &lt;subscription_id&gt; &lt;sp_object_id&gt;</code></pre>
                    </li>
                </ol>

                <h5 class="mt-3">Option B: Manual CLI Commands</h5>
                <pre class="p-3 rounded"><code># 1. Update azure_custom_role.json with your subscription ID
# 2. Create the custom role
az role definition create --role-definition @azure_custom_role.json

# 3. Assign the role to your service principal
az role assignment create \
    --assignee-object-id &lt;sp_object_id&gt; \
    --assignee-principal-type ServicePrincipal \
    --role "Digital Twin Deployer" \
    --scope "/subscriptions/&lt;subscription_id&gt;"</code></pre>

                <h5 class="mt-4">Option C: Azure Portal (GUI)</h5>

                <p><strong>Part 1: Create the Custom Role</strong></p>
                <ol>
                    <li>Download: <a href="references/azure_custom_role.json" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fa-solid fa-download me-1"></i>azure_custom_role.json
                        </a></li>
                    <li>Edit the file and replace <code>REPLACE_WITH_YOUR_SUBSCRIPTION_ID</code> with your actual
                        subscription ID</li>
                    <li>In Azure Portal, navigate to your <a
                            href="https://portal.azure.com/#view/Microsoft_Azure_Billing/SubscriptionsBlade"
                            target="_blank">Subscription</a></li>
                    <li>Go to <strong>Access control (IAM)</strong> → <strong>Add</strong> → <strong>Add custom
                            role</strong></li>
                    <li>On the Basics tab, select <strong>Start from JSON</strong></li>
                    <li>Click the folder icon next to "Select a file" and upload your edited JSON file</li>
                    <li>Review the permissions on the <strong>Permissions</strong> tab</li>
                    <li>Click <strong>Review + create</strong> → <strong>Create</strong></li>
                </ol>

                <p class="mt-3"><strong>Part 2: Assign the Role to Your Service Principal</strong></p>
                <ol>
                    <li>Go to <strong>Access control (IAM)</strong> → <strong>Add</strong> → <strong>Add role
                            assignment</strong></li>
                    <li>Switch to the <strong>Privileged administrator roles</strong> tab (the custom role appears here
                        because it includes role assignment permissions)</li>
                    <li>Select <strong>Digital Twin Deployer</strong> → <strong>Next</strong></li>
                    <li>Select <strong>User, group, or service principal</strong> → <strong>Select members</strong></li>
                    <li>Search for your App Registration name and select it → <strong>Next</strong></li>
                    <li>On the <strong>Conditions</strong> tab, select <strong>"Constrain roles"</strong>
                        (Allow user to only assign roles you select):
                        <ul class="mt-2">
                            <li>Click <strong>Select roles</strong></li>
                            <li>Search for and add exactly these 3 roles:
                                <ul>
                                    <li><code>Azure Digital Twins Data Owner</code></li>
                                    <li><code>IoT Hub Data Contributor</code></li>
                                    <li><code>IoT Hub Registry Contributor</code></li>
                                </ul>
                            </li>
                            <li>Click <strong>Save</strong></li>
                        </ul>
                    </li>
                    <li>Click <strong>Review + assign</strong></li>
                </ol>

                <div class="callout tip mt-3">
                    <strong><i class="fa-solid fa-lightbulb me-2"></i>Why These 3 Roles?</strong>
                    The deployer assigns these roles to the <strong>Managed Identity</strong> (not to users):
                    <ul>
                        <li><strong>Azure Digital Twins Data Owner</strong> - For functions to read/write ADT data</li>
                        <li><strong>IoT Hub Data/Registry Contributor</strong> - For functions to access IoT Hub</li>
                    </ul>
                    By constraining to these 3 roles, the Service Principal cannot escalate privileges.
                </div>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-clock me-2"></i>Propagation Time</strong>
                    It may take a few minutes for the new custom role to propagate throughout your Azure tenant.
                </div>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-shield-halved me-2"></i>Development Alternative</strong>
                    For quick development/testing only, you can use <strong>Contributor</strong> +
                    <strong>User Access Administrator</strong> built-in roles instead. This is less secure
                    but faster to set up.
                </div>

                <h5 class="mt-3">Required Roles Summary</h5>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Layer</th>
                            <th>Services</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge text-bg-secondary">Setup</span></td>
                            <td>Resource Groups, Managed Identity, Storage</td>
                            <td>Foundation resources for all layers</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-warning">L0</span></td>
                            <td>App Service Plan, Function Apps</td>
                            <td>Multi-cloud HTTP receivers</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L1</span></td>
                            <td>IoT Hub, Event Grid</td>
                            <td>IoT ingestion, device management</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L2</span></td>
                            <td>Function Apps</td>
                            <td>Event processing, routing</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L3</span></td>
                            <td>Cosmos DB, Blob Storage</td>
                            <td>Hot/Cold/Archive data storage</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L4</span></td>
                            <td>Azure Digital Twins</td>
                            <td>Digital twin instance and models</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L5</span></td>
                            <td>Azure Managed Grafana</td>
                            <td>Visualization dashboards</td>
                        </tr>
                    </tbody>
                </table>

                <h4 class="mt-4">Step 3: Get Subscription ID</h4>
                <ol>
                    <li>In Azure Portal, go to <strong>Subscriptions</strong></li>
                    <li>Copy your <strong>Subscription ID</strong></li>
                </ol>

                <h4 class="mt-4">Step 4: Configure Credentials</h4>
                <p>Add your credentials to <code>config_credentials.json</code>:</p>
                <pre class="p-3 rounded"><code>{
  "azure": {
    "azure_subscription_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "azure_tenant_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "azure_client_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "azure_client_secret": "your-client-secret-value",
    "azure_region": "westeurope"
  }
}</code></pre>

                <h4 class="mt-4">Step 5: Verify Permissions</h4>
                <p>Use the deployer's built-in credential checker to verify your setup:</p>
                <pre class="p-3 rounded"><code># CLI
python main.py
>>> check_credentials azure

# REST API
GET /credentials/check/azure</code></pre>
            </div>


            <!-- GCP Setup -->
            <div class="card mb-4" id="gcp-setup">
                <h2 class="mb-3"><i class="fa-brands fa-google me-2"></i>GCP Setup <span
                        class="badge bg-secondary">Coming Soon</span></h2>

                <div class="callout info">
                    <strong><i class="fa-solid fa-code-branch me-2"></i>Under Development</strong>
                    Google Cloud Platform provider support is currently in development. This section will be
                    updated once the GCP deployment adapter is complete.
                </div>

                <h4 class="mt-3">Expected Requirements</h4>
                <ul>
                    <li><strong>Project ID:</strong> Your GCP project identifier</li>
                    <li><strong>Service Account JSON:</strong> Path to service account credentials file</li>
                    <li><strong>Region:</strong> Deployment region (e.g., <code>europe-west1</code>)</li>
                </ul>

                <h4 class="mt-3">Expected Services</h4>
                <ul>
                    <li>Cloud IoT Core / Pub/Sub (L1)</li>
                    <li>Cloud Functions (L2)</li>
                    <li>Firestore, Cloud Storage (L3)</li>
                    <li>Custom Digital Twin solution (L4)</li>
                    <li>Managed Grafana or Looker (L5)</li>
                </ul>
            </div>

        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <script src="js/docs-nav.js" defer></script>
</body>

</html>