<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>GCP Credentials Setup — Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-brands fa-google me-2"></i> GCP Credentials Setup
            </h1>

            <p class="text-muted mb-4">
                Configure Google Cloud Platform Service Account credentials for deploying your Digital Twin
                infrastructure.
            </p>

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="docs-credentials-setup.html">Credentials Setup</a></li>
                    <li class="breadcrumb-item active" aria-current="page">GCP</li>
                </ol>
            </nav>

            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list me-2"></i>Contents</h2>
                    <ul>
                        <li><a href="#step1">Step 1: Create a GCP Project (or Use Existing)</a></li>
                        <li><a href="#step2">Step 2: Enable Required APIs</a></li>
                        <li><a href="#step3">Step 3: Create Service Account</a></li>
                        <li><a href="#step4">Step 4: Assign IAM Roles</a></li>
                        <li><a href="#step5">Step 5: Create and Download Key</a></li>
                        <li><a href="#step6">Step 6: Configure Credentials</a></li>
                        <li><a href="#step7">Step 7: Verify Permissions</a></li>
                    </ul>
                </div>
            </div>

            <!-- Step 1 -->
            <div class="card mb-4" id="step1">
                <h2 class="mb-3">Step 1: Create a GCP Project (or Use Existing)</h2>

                <p>You have two options:</p>

                <h5>Option A: Use Existing Project</h5>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/projectselector2/home/dashboard"
                            target="_blank">Google Cloud Console</a></li>
                    <li>Select your existing project from the dropdown</li>
                    <li>Copy the <strong>Project ID</strong> (not the project name) → <code>gcp_project_id</code></li>
                </ol>

                <h5 class="mt-4">Option B: Let Terraform Create a New Project</h5>
                <ol>
                    <li>Leave <code>gcp_project_id</code> empty in your credentials</li>
                    <li>Provide your <code>gcp_billing_account</code> ID</li>
                    <li>Terraform will create a project named <code>{digital_twin_name}-project</code></li>
                </ol>

                <p><strong>To find your billing account ID:</strong></p>
                <pre class="p-3 rounded"><code># Via gcloud CLI
gcloud billing accounts list

# Or in Console: https://console.cloud.google.com/billing</code></pre>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>Billing Account Format</strong>
                    Billing account IDs look like: <code>0XXXXX-XXXXXX-XXXXXX</code>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="card mb-4" id="step2">
                <h2 class="mb-3">Step 2: Enable Required APIs</h2>

                <div class="callout info">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>What are APIs?</strong>
                    <p class="mb-0">Google Cloud services must be explicitly enabled ("APIs") before you can create
                        resources. Terraform will enable these automatically, but pre-enabling them speeds up
                        deployment.</p>
                </div>

                <p class="mt-3"><strong>Run this command to enable all required APIs:</strong></p>
                <pre class="p-3 rounded"><code># Enable all required APIs (one-time per project)
gcloud services enable \
  cloudresourcemanager.googleapis.com \
  iam.googleapis.com \
  storage.googleapis.com \
  pubsub.googleapis.com \
  eventarc.googleapis.com \
  cloudfunctions.googleapis.com \
  run.googleapis.com \
  cloudbuild.googleapis.com \
  firestore.googleapis.com \
  cloudscheduler.googleapis.com

# Verify APIs are enabled
gcloud services list --enabled</code></pre>

                <table class="table table-sm table-striped mt-3">
                    <thead>
                        <tr>
                            <th>Layer</th>
                            <th>API</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge text-bg-secondary">Setup</span></td>
                            <td><code>cloudresourcemanager, iam, storage</code></td>
                            <td>Projects, IAM, Storage buckets</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L1</span></td>
                            <td><code>pubsub, eventarc</code></td>
                            <td>Pub/Sub topics, event triggers</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L2</span></td>
                            <td><code>cloudfunctions, run, cloudbuild</code></td>
                            <td>Cloud Functions (Gen2)</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L3</span></td>
                            <td><code>firestore, storage, cloudscheduler</code></td>
                            <td>Firestore, Cloud Storage, Scheduler</td>
                        </tr>
                    </tbody>
                </table>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>L4/L5 Not Available</strong>
                    GCP does not have managed Digital Twin or Grafana equivalents.
                    Consider self-hosted solutions for these layers.
                </div>
            </div>

            <!-- Step 3 -->
            <div class="card mb-4" id="step3">
                <h2 class="mb-3">Step 3: Create Service Account</h2>

                <div class="callout info tip mb-3">
                    <strong><i class="fa-solid fa-robot me-2"></i>Terraform Creates This Automatically</strong>
                    <p class="mb-0">If you're using Terraform for deployment, it creates a dedicated service account
                        (<code>{digital_twin_name}-functions-sa</code>) for Cloud Functions automatically.
                        You only need to create a service account manually if you want to run the credential checker
                        or use the deployer API before running Terraform.</p>
                </div>

                <p><strong>Manual creation (optional):</strong></p>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">IAM &
                            Admin → Service Accounts</a></li>
                    <li>Click <strong>Create Service Account</strong></li>
                    <li>Enter a name (e.g., <code>digital-twin-deployer</code>)</li>
                    <li>Click <strong>Create and Continue</strong></li>
                </ol>

                <p><strong>Or via CLI:</strong></p>
                <pre class="p-3 rounded"><code>gcloud iam service-accounts create digital-twin-deployer \
  --display-name="Digital Twin Deployer"</code></pre>
            </div>

            <!-- Step 4 -->
            <div class="card mb-4" id="step4">
                <h2 class="mb-3">Step 4: Assign IAM Roles</h2>

                <p>For <strong>least-privilege security</strong>, we provide a custom role definition with only the
                    permissions required by the deployer. This is more secure than using broad Editor/Owner roles.</p>

                <h5 class="mt-4">Option A: Custom Role via gcloud CLI (Recommended)</h5>
                <p>Download our custom role YAML and create it using the command line:</p>
                <ol>
                    <li>Download:
                        <a href="references/gcp_custom_role.yaml" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fa-solid fa-download me-1"></i>gcp_custom_role.yaml
                        </a>
                    </li>
                    <li>Create the custom role:
                        <pre class="p-2 rounded mt-2"><code>gcloud iam roles create DigitalTwinDeployer \
  --project=YOUR_PROJECT_ID \
  --file=gcp_custom_role.yaml</code></pre>
                    </li>
                    <li>Assign the role to your service account:
                        <pre class="p-2 rounded mt-2"><code>gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
  --member="serviceAccount:YOUR_SA@YOUR_PROJECT.iam.gserviceaccount.com" \
  --role="projects/YOUR_PROJECT_ID/roles/DigitalTwinDeployer"</code></pre>
                    </li>
                </ol>

                <h5 class="mt-4">Option A2: Custom Role via Cloud Shell (Browser CLI)</h5>
                <p>Use Cloud Shell directly in your browser to run the CLI commands:</p>
                <ol>
                    <li>Open <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                    <li>Click the <strong>Cloud Shell</strong> icon (<code>&gt;_</code>) in the top-right corner</li>
                    <li>Wait for the Cloud Shell terminal to start</li>
                    <li>Upload the YAML file:
                        <ul>
                            <li>Click the <strong>⋮</strong> (More) menu in Cloud Shell</li>
                            <li>Select <strong>Upload</strong></li>
                            <li>Choose <code>gcp_custom_role.yaml</code> from your computer</li>
                        </ul>
                    </li>
                    <li>Run the create command:
                        <pre class="p-2 rounded mt-2"><code>gcloud iam roles create DigitalTwinDeployer \
  --project=$GOOGLE_CLOUD_PROJECT \
  --file=gcp_custom_role.yaml</code></pre>
                    </li>
                    <li>Assign the role:
                        <pre class="p-2 rounded mt-2"><code>gcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT \
  --member="serviceAccount:YOUR_SA@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com" \
  --role="projects/$GOOGLE_CLOUD_PROJECT/roles/DigitalTwinDeployer"</code></pre>
                    </li>
                </ol>

                <div class="callout tip mt-3">
                    <strong><i class="fa-solid fa-terminal me-2"></i>Cloud Shell Tip</strong>
                    <code>$GOOGLE_CLOUD_PROJECT</code> is automatically set to your current project in Cloud Shell.
                </div>

                <div class="callout info tip mt-4 mb-3">
                    <strong><i class="fa-solid fa-robot me-2"></i>Terraform Handles This Automatically!</strong>
                    <p class="mb-0">If you're using Terraform for deployment, you can <strong>skip this step
                            entirely</strong>.
                        Terraform creates a custom IAM role (<code>{twin_name}_functions_role</code>) with
                        least-privilege permissions and assigns it to the service account automatically via
                        <code>google_project_iam_custom_role</code> in <code>gcp_setup.tf</code>.
                    </p>
                </div>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-file-code me-2"></i>GCP Uses YAML Format</strong>
                    Unlike Azure (which uses JSON), GCP custom role definitions use YAML format.
                    The YAML file contains 130+ permissions organized by service.
                </div>

                <h5 class="mt-4">Option B: Predefined Roles (Quick Setup)</h5>
                <p>Alternatively, assign these predefined roles:</p>

                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Role</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>roles/cloudfunctions.developer</code></td>
                            <td>Create/manage Cloud Functions</td>
                        </tr>
                        <tr>
                            <td><code>roles/pubsub.editor</code></td>
                            <td>Create/manage Pub/Sub topics</td>
                        </tr>
                        <tr>
                            <td><code>roles/datastore.user</code></td>
                            <td>Read/write Firestore data</td>
                        </tr>
                        <tr>
                            <td><code>roles/storage.objectAdmin</code></td>
                            <td>Manage Cloud Storage objects</td>
                        </tr>
                        <tr>
                            <td><code>roles/run.invoker</code></td>
                            <td>Invoke Cloud Run services</td>
                        </tr>
                        <tr>
                            <td><code>roles/cloudscheduler.admin</code></td>
                            <td>Create scheduled jobs</td>
                        </tr>
                        <tr>
                            <td><code>roles/iam.serviceAccountUser</code></td>
                            <td>Act as other service accounts</td>
                        </tr>
                    </tbody>
                </table>

                <p><strong>Assign roles via CLI:</strong></p>
                <pre class="p-3 rounded"><code>PROJECT_ID="your-project-id"
SA_EMAIL="digital-twin-deployer@${PROJECT_ID}.iam.gserviceaccount.com"

# Assign required roles
for ROLE in \
  roles/cloudfunctions.developer \
  roles/pubsub.editor \
  roles/datastore.user \
  roles/storage.objectAdmin \
  roles/run.invoker \
  roles/cloudscheduler.admin \
  roles/iam.serviceAccountUser
do
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$SA_EMAIL" \
    --role="$ROLE"
done</code></pre>

                <div class="callout tip mt-3">
                    <strong><i class="fa-solid fa-lightbulb me-2"></i>For Project Creation</strong>
                    If Terraform will create a new project, the service account also needs
                    <code>roles/resourcemanager.projectCreator</code> at the organization or folder level.
                </div>
            </div>

            <!-- Step 5 -->
            <div class="card mb-4" id="step5">
                <h2 class="mb-3">Step 5: Create and Download Key</h2>

                <ol>
                    <li>In <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">Service
                            Accounts</a>, click on your service account</li>
                    <li>Go to <strong>Keys</strong> tab</li>
                    <li>Click <strong>Add Key</strong> → <strong>Create new key</strong></li>
                    <li>Select <strong>JSON</strong> format</li>
                    <li>Click <strong>Create</strong> — the key file downloads automatically</li>
                    <li>Save the file securely (e.g., <code>~/gcp-credentials.json</code>)</li>
                </ol>

                <p><strong>Or via CLI:</strong></p>
                <pre class="p-3 rounded"><code>gcloud iam service-accounts keys create ~/gcp-credentials.json \
  --iam-account=digital-twin-deployer@${PROJECT_ID}.iam.gserviceaccount.com</code></pre>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Security Warning</strong>
                    Keep the JSON key file secure! Never commit it to version control.
                    Anyone with this file has the same permissions as the service account.
                </div>
            </div>

            <!-- Step 6 -->
            <div class="card mb-4" id="step6">
                <h2 class="mb-3">Step 6: Configure Credentials</h2>

                <p>Add your credentials to <code>config_credentials.json</code>:</p>
                <pre class="p-3 rounded"><code>{
  "gcp": {
    "gcp_project_id": "your-project-id",
    "gcp_billing_account": "",
    "gcp_credentials_file": "/path/to/gcp-credentials.json",
    "gcp_region": "europe-west1"
  }
}</code></pre>

                <table class="table table-sm mt-3">
                    <thead>
                        <tr>
                            <th>Field</th>
                            <th>Description</th>
                            <th>Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>gcp_project_id</code></td>
                            <td>Existing project ID (leave empty to create new)</td>
                            <td>One of these</td>
                        </tr>
                        <tr>
                            <td><code>gcp_billing_account</code></td>
                            <td>Billing account for new project creation</td>
                            <td>is required</td>
                        </tr>
                        <tr>
                            <td><code>gcp_credentials_file</code></td>
                            <td>Path to service account JSON key</td>
                            <td>Yes</td>
                        </tr>
                        <tr>
                            <td><code>gcp_region</code></td>
                            <td>GCP region for resources</td>
                            <td>Yes</td>
                        </tr>
                    </tbody>
                </table>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-map-marker-alt me-2"></i>Recommended Regions</strong>
                    <code>europe-west1</code> (Belgium), <code>us-central1</code> (Iowa),
                    <code>asia-east1</code> (Taiwan) have good availability for all services.
                </div>
            </div>

            <!-- Step 7 -->
            <div class="card mb-4" id="step7">
                <h2 class="mb-3">Step 7: Verify Permissions</h2>

                <p>Use the deployer's built-in credential checker to verify your setup:</p>
                <pre class="p-3 rounded"><code># CLI
python main.py
>>> check_credentials gcp

# REST API
GET /credentials/check/gcp</code></pre>

                <p>The checker validates:</p>
                <ul>
                    <li>Service account key file exists and is valid JSON</li>
                    <li>Project access (if project_id provided)</li>
                    <li>Required APIs are enabled</li>
                </ul>
            </div>

        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <script src="js/docs-nav.js" defer></script>
</body>

</html>