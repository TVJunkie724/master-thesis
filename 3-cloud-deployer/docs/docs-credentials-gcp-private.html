<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>GCP Private Account Setup — Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-brands fa-google me-2"></i> GCP Private Account Setup
            </h1>

            <p class="text-muted mb-4">
                Set up GCP credentials for a <strong>private Gmail account</strong> (no organization).
                Uses an existing GCP project.
            </p>

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="docs-credentials-setup.html">Credentials Setup</a></li>
                    <li class="breadcrumb-item"><a href="docs-credentials-gcp.html">GCP</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Private Account</li>
                </ol>
            </nav>

            <!-- Overview -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <i class="fa-solid fa-circle-check me-2"></i>Simpler Setup for Private Accounts
                </div>
                <div class="card-body">
                    <p>If you're using a <strong>personal Gmail account</strong> (not Google Workspace), you don't have
                        a GCP organization. This simplified flow uses your <strong>existing project</strong> instead of
                        creating a new one.</p>

                    <div class="bg-light p-3 rounded mb-3">
                        <pre class="mb-0"><code>┌─────────────────────────────────────────────────────────────┐
│  YOUR EXISTING GCP PROJECT                                  │
│  └── Service Account (you create this)                      │
│        └── Has: Editor + Role Administrator roles           │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼ Terraform deploys to this project:
┌─────────────────────────────────────────────────────────────┐
│  SAME PROJECT: Resources deployed here                      │
│  └── Pub/Sub, Cloud Functions, Firestore, etc.             │
└─────────────────────────────────────────────────────────────┘</code></pre>
                    </div>

                    <p class="mb-0"><strong>Advantages:</strong> No organization needed, no project creator
                        permissions, simpler IAM setup.</p>
                </div>
            </div>

            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list me-2"></i>Contents</h2>
                    <ul>
                        <li><a href="#step1">Step 1: Create or Choose a GCP Project</a></li>
                        <li><a href="#step2">Step 2: Create Service Account & Download Key</a></li>
                        <li><a href="#step3">Step 3: Grant Permissions</a></li>
                        <li><a href="#step4">Step 4: Enable Cloud Resource Manager API</a></li>
                        <li><a href="#step5">Step 5: Configure Credentials</a></li>
                        <li><a href="#step6">Step 6: Verify Setup</a></li>
                    </ul>
                </div>
            </div>

            <!-- Step 1 -->
            <div class="card mb-4" id="step1">
                <h2 class="mb-3">Step 1: Create or Choose a GCP Project</h2>

                <p>You need an existing GCP project. You can use any project you have access to, or create a new one:
                </p>

                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/projectcreate" target="_blank">Create a
                            Project</a></li>
                    <li>Enter a project name (e.g., <code>digital-twin-dev</code>)</li>
                    <li>Click <strong>Create</strong></li>
                    <li>Note your <strong>Project ID</strong> (shown below the name)</li>
                </ol>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>Project ID Format</strong>
                    <p class="mb-0">Project IDs look like: <code>digital-twin-dev</code> or
                        <code>my-project-123456</code>. This is different from the project name.
                    </p>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="card mb-4" id="step2">
                <h2 class="mb-3">Step 2: Create Service Account & Download Key</h2>

                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">IAM &
                            Admin → Service Accounts</a></li>
                    <li>Select your project from the dropdown at the top</li>
                    <li>Click <strong>Create Service Account</strong></li>
                    <li>Name: <code>digital-twin-deployer</code></li>
                    <li>Click <strong>Create and Continue</strong></li>
                    <li>Skip the optional steps and click <strong>Done</strong></li>
                </ol>

                <h5 class="mt-4">Download the Key</h5>
                <ol>
                    <li>Click on the service account you just created</li>
                    <li>Go to <strong>Keys</strong> tab</li>
                    <li>Click <strong>Add Key</strong> → <strong>Create new key</strong></li>
                    <li>Select <strong>JSON</strong> format</li>
                    <li>Click <strong>Create</strong> — the key file downloads automatically</li>
                    <li>Save the file securely (e.g., <code>~/gcp-credentials.json</code>)</li>
                </ol>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Security Warning</strong>
                    Keep the JSON key file secure! Never commit it to version control.
                </div>
            </div>

            <!-- Step 3 -->
            <div class="card mb-4" id="step3">
                <h2 class="mb-3">Step 3: Grant Permissions</h2>

                <p>Grant the service account permissions to manage resources in your project:</p>

                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/iam-admin/iam" target="_blank">IAM & Admin →
                            IAM</a></li>
                    <li>Make sure your project is selected at the top</li>
                    <li>Click <strong>Grant Access</strong></li>
                    <li>Enter your service account email:
                        <code>digital-twin-deployer@YOUR_PROJECT.iam.gserviceaccount.com</code>
                    </li>
                    <li>Add the following roles:
                        <ul>
                            <li><strong>Editor</strong> (<code>roles/editor</code>) - for managing all resources</li>
                            <li><strong>Role Administrator</strong> (<code>roles/iam.roleAdmin</code>) - for creating
                                custom IAM roles</li>
                            <li><strong>Project IAM Admin</strong> (<code>roles/resourcemanager.projectIamAdmin</code>)
                                - for binding IAM roles to service accounts</li>
                            <li><strong>Datastore Owner</strong> (<code>roles/datastore.owner</code>) - for creating
                                Firestore databases</li>
                            <li><strong>Cloud Run Admin</strong> (<code>roles/run.admin</code>) - for setting IAM
                                policies on Cloud Functions</li>
                        </ul>
                    </li>
                    <li>Click <strong>Save</strong></li>
                </ol>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Role Administrator Required</strong>
                    <p class="mb-0">The <code>roles/iam.roleAdmin</code> permission is required because Terraform
                        creates
                        a custom IAM role with least-privilege permissions for the Cloud Functions service account.
                        Without this role, deployment will fail with "You don't have permission to create a role".</p>
                </div>

                <div class="callout tip mt-3">
                    <strong><i class="fa-solid fa-lightbulb me-2"></i>Alternative: Owner Role</strong>
                    <p class="mb-0">If you encounter permission issues, you can use the <strong>Owner</strong> role
                        instead. This grants full access to all resources in the project, including IAM role creation.
                    </p>
                </div>
            </div>

            <!-- Step 4: Enable Cloud Resource Manager API -->
            <div class="card mb-4" id="step4">
                <h2 class="mb-3">Step 4: Enable Cloud Resource Manager API</h2>

                <div class="callout warn">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Required for Credentials
                        Validation</strong>
                    <p class="mb-0">This API must be enabled before running the credentials check endpoint.
                        Terraform will enable other APIs automatically during deployment.</p>
                </div>

                <p class="mt-3">Enable the Cloud Resource Manager API in your project:</p>

                <ol>
                    <li>Go to <a
                            href="https://console.cloud.google.com/apis/library/cloudresourcemanager.googleapis.com"
                            target="_blank">APIs & Services → Cloud Resource Manager API</a></li>
                    <li>Make sure your project is selected at the top</li>
                    <li>Click <strong>Enable</strong></li>
                </ol>

                <p>Or via gcloud CLI:</p>
                <pre
                    class="p-3 rounded"><code>gcloud services enable cloudresourcemanager.googleapis.com --project=YOUR_PROJECT_ID</code></pre>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>Wait a Few Minutes</strong>
                    <p class="mb-0">After enabling the API, wait 1-2 minutes for the change to propagate before running
                        the credentials check.</p>
                </div>
            </div>

            <!-- Step 5 -->
            <div class="card mb-4" id="step5">
                <h2 class="mb-3">Step 5: Configure Credentials</h2>

                <p>Add your credentials to <code>config_credentials.json</code>:</p>
                <pre class="p-3 rounded"><code>{
  "gcp": {
    "gcp_project_id": "your-project-id",
    "gcp_credentials_file": "/path/to/gcp-credentials.json",
    "gcp_region": "europe-west1"
  }
}</code></pre>

                <table class="table table-sm mt-3">
                    <thead>
                        <tr>
                            <th>Field</th>
                            <th>Description</th>
                            <th>Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>gcp_project_id</code></td>
                            <td>Your existing GCP Project ID</td>
                            <td><strong>Yes</strong></td>
                        </tr>
                        <tr>
                            <td><code>gcp_credentials_file</code></td>
                            <td>Path to service account JSON key</td>
                            <td><strong>Yes</strong></td>
                        </tr>
                        <tr>
                            <td><code>gcp_region</code></td>
                            <td>GCP region for resources</td>
                            <td><strong>Yes</strong></td>
                        </tr>
                    </tbody>
                </table>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>No Billing Account Needed</strong>
                    <p class="mb-0">Since you're using an existing project, you don't need to provide a billing account
                        ID. The project is already linked to your billing.</p>
                </div>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Precedence Rule</strong>
                    <p class="mb-0">If you accidentally provide both <code>gcp_project_id</code> and
                        <code>gcp_billing_account</code>, the system uses <code>gcp_project_id</code> (existing project
                        mode)
                        and ignores the billing account.
                    </p>
                </div>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-map-marker-alt me-2"></i>Recommended Regions</strong>
                    <code>europe-west1</code> (Belgium), <code>us-central1</code> (Iowa),
                    <code>asia-east1</code> (Taiwan) have good availability for all services.
                </div>
            </div>

            <!-- Step 6 -->
            <div class="card mb-4" id="step6">
                <h2 class="mb-3">Step 6: Verify Setup</h2>

                <p>Use the deployer's built-in credential checker to verify your setup:</p>
                <pre class="p-3 rounded"><code># CLI
python main.py
>>> check_credentials gcp

# REST API
GET /permissions/verify/gcp</code></pre>

                <p>The checker validates:</p>
                <ul>
                    <li>Service account key file exists and is valid JSON</li>
                    <li>Project access works</li>
                    <li>Required APIs are enabled</li>
                </ul>

                <h5 class="mt-4">Understanding Validation Status</h5>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Meaning</th>
                            <th>Can Deploy?</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-success">
                            <td><code>valid</code></td>
                            <td>All APIs enabled, ready to deploy</td>
                            <td><strong>Yes</strong></td>
                        </tr>
                        <tr class="table-warning">
                            <td><code>partial</code></td>
                            <td>Credentials work, some APIs not enabled yet</td>
                            <td><strong>Yes</strong> - Terraform enables them automatically</td>
                        </tr>
                        <tr class="table-danger">
                            <td><code>invalid</code></td>
                            <td>Credentials don't work (wrong file, permissions, etc.)</td>
                            <td>No - fix credentials first</td>
                        </tr>
                    </tbody>
                </table>

                <div class="callout success tip mt-3">
                    <strong><i class="fa-solid fa-lightbulb me-2"></i>'Partial' is Fine</strong>
                    <p class="mb-0">A <code>partial</code> status means your credentials work correctly.
                        The missing APIs (Pub/Sub, Cloud Functions, Firestore, etc.) will be enabled
                        automatically during <code>terraform apply</code>. No manual action needed!</p>
                </div>
            </div>

            <!-- Alternative -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <i class="fa-solid fa-building me-2"></i>Have an Organization?
                </div>
                <div class="card-body">
                    <p class="mb-0">If you have a Google Workspace or Cloud Identity organization, you can use the
                        <a href="docs-credentials-gcp-org.html"><strong>Organization Account Setup</strong></a> instead.
                        This allows Terraform to auto-create a new project for each deployment.
                    </p>
                </div>
            </div>

        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <script src="js/docs-nav.js" defer></script>
</body>

</html>