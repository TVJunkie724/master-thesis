<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Azure Credentials Setup — Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-brands fa-microsoft me-2"></i> Azure Credentials Setup
            </h1>

            <p class="text-muted mb-4">
                Configure Azure Service Principal credentials and RBAC permissions for deploying your Digital Twin
                infrastructure.
            </p>

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="docs-credentials-setup.html">Credentials Setup</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Azure</li>
                </ol>
            </nav>

            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list me-2"></i>Contents</h2>
                    <ul>
                        <li><a href="#step1">Step 1: Create App Registration (Service Principal)</a></li>
                        <li><a href="#step2">Step 2: Register Resource Providers</a></li>
                        <li><a href="#step3">Step 3: Create Custom Role</a></li>
                        <li><a href="#step4">Step 4: Find Allowed Regions</a></li>
                        <li><a href="#step5">Step 5: Get Subscription ID</a></li>
                        <li><a href="#step6">Step 6: Configure Credentials</a></li>
                        <li><a href="#step7">Step 7: Verify Permissions</a></li>
                    </ul>
                </div>
            </div>

            <!-- Step 1 -->
            <div class="card mb-4" id="step1">
                <h2 class="mb-3">Step 1: Create App Registration (Service Principal)</h2>

                <ol>
                    <li>Sign in to the <a
                            href="https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/RegisteredApps"
                            target="_blank">Azure Portal - App Registrations</a></li>
                    <li>Click <strong>New registration</strong></li>
                    <li>Enter a name (e.g., <code>digital-twin-deployer</code>)</li>
                    <li>Select <strong>Accounts in this organizational directory only</strong></li>
                    <li>Click <strong>Register</strong></li>
                    <li>From the overview page, copy:
                        <ul>
                            <li><strong>Application (client) ID</strong> → <code>azure_client_id</code></li>
                            <li><strong>Directory (tenant) ID</strong> → <code>azure_tenant_id</code></li>
                        </ul>
                    </li>
                    <li>Go to <strong>Certificates & secrets</strong> → <strong>New client secret</strong></li>
                    <li>Add a description and expiry, click <strong>Add</strong></li>
                    <li>Copy the <strong>Value</strong> immediately → <code>azure_client_secret</code></li>
                </ol>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Important</strong>
                    Copy the client secret value immediately! It won't be shown again after you leave this page.
                </div>
            </div>

            <!-- Step 2 -->
            <div class="card mb-4" id="step2">
                <h2 class="mb-3">Step 2: Register Resource Providers (One-Time)</h2>

                <div class="callout info">
                    <strong><i class="fa-solid fa-puzzle-piece me-2"></i>What are Resource Providers?</strong>
                    <p class="mb-2">A <strong>resource provider</strong> is a service that supplies Azure resources.
                        For example, <code>Microsoft.Storage</code> provides storage accounts, and
                        <code>Microsoft.DigitalTwins</code> provides Azure Digital Twins instances.
                    </p>
                    <p class="mb-0">Before you can deploy a resource type, the corresponding provider must be
                        <strong>registered</strong> with your subscription. New/student subscriptions often lack
                        registrations for specialized services. This is a one-time setup per subscription.
                    </p>
                </div>

                <p class="mt-3"><strong>Run these CLI commands:</strong></p>
                <pre class="p-3 rounded"><code># Register all required resource providers (one-time per subscription)
az provider register --namespace Microsoft.ManagedIdentity
az provider register --namespace Microsoft.Web
az provider register --namespace Microsoft.Storage
az provider register --namespace Microsoft.Devices
az provider register --namespace Microsoft.EventGrid
az provider register --namespace Microsoft.DocumentDB
az provider register --namespace Microsoft.DigitalTwins
az provider register --namespace Microsoft.Dashboard
az provider register --namespace Microsoft.Authorization

# Check registration status (all should show "Registered")
az provider show -n Microsoft.ManagedIdentity --query "registrationState" -o tsv
az provider show -n Microsoft.Web --query "registrationState" -o tsv</code></pre>

                <div class="callout tip mt-3">
                    <strong><i class="fa-solid fa-clock me-2"></i>Wait Time</strong>
                    Registration takes 1-2 minutes per provider. You can check status with
                    <code>az provider show -n &lt;namespace&gt; --query registrationState</code>.
                    Wait until all show "Registered" before proceeding.
                </div>

                <p><strong>Via Azure Portal:</strong></p>
                <ol>
                    <li>Go to <a href="https://portal.azure.com/#view/Microsoft_Azure_Billing/SubscriptionsBlade"
                            target="_blank">Subscriptions</a></li>
                    <li>Select your subscription from the list</li>
                    <li>In the left menu, scroll down to <strong>Settings</strong> section</li>
                    <li>Click <strong>Resource providers</strong></li>
                    <li>For each of the following providers, use the <strong>Filter by name...</strong> search box,
                        select the row, and click <strong>Register</strong>:
                        <ul class="mt-2">
                            <li><code>Microsoft.ManagedIdentity</code></li>
                            <li><code>Microsoft.Web</code></li>
                            <li><code>Microsoft.Storage</code></li>
                            <li><code>Microsoft.Devices</code></li>
                            <li><code>Microsoft.EventGrid</code></li>
                            <li><code>Microsoft.DocumentDB</code></li>
                            <li><code>Microsoft.DigitalTwins</code></li>
                            <li><code>Microsoft.Dashboard</code></li>
                            <li><code>Microsoft.Authorization</code></li>
                        </ul>
                    </li>
                    <li>Wait for each status to change from "NotRegistered" to "Registered"</li>
                </ol>
            </div>

            <!-- Step 3 -->
            <div class="card mb-4" id="step3">
                <h2 class="mb-3">Step 3: Create Custom Role (Recommended)</h2>

                <p>For <strong>least-privilege security</strong>, we provide a custom role definition with only the
                    permissions required by the deployer. This is more secure than using broad Contributor/Owner roles.
                </p>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>Custom Role Includes</strong>
                    <ul class="mb-0 mt-2">
                        <li><code>*/read</code> - Read access to all resources (for credential verification, status
                            checks)</li>
                        <li>Write/Delete permissions only for the specific services needed per layer</li>
                        <li>Data plane access for Azure Digital Twins</li>
                    </ul>
                </div>

                <h5 class="mt-4">Option A: Automated Setup Script</h5>
                <p>Download and run our setup script:</p>
                <ol>
                    <li>Download:
                        <a href="references/azure_custom_role.json" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fa-solid fa-download me-1"></i>azure_custom_role.json
                        </a>
                        <a href="references/setup_azure_role.sh" target="_blank"
                            class="btn btn-sm btn-outline-secondary ms-2">
                            <i class="fa-solid fa-download me-1"></i>setup_azure_role.sh
                        </a>
                    </li>
                    <li>Find your Service Principal Object ID:
                        <pre
                            class="p-2 rounded mt-2"><code>az ad sp show --id &lt;your_client_id&gt; --query id -o tsv</code></pre>
                    </li>
                    <li>Run the setup script:
                        <pre class="p-2 rounded mt-2"><code>chmod +x setup_azure_role.sh
./setup_azure_role.sh &lt;subscription_id&gt; &lt;sp_object_id&gt;</code></pre>
                    </li>
                </ol>

                <h5 class="mt-4">Option B: Manual CLI Commands</h5>
                <pre class="p-3 rounded"><code># 1. Update azure_custom_role.json with your subscription ID
# 2. Create the custom role
az role definition create --role-definition @azure_custom_role.json

# 3. Assign the role to your service principal
az role assignment create \
    --assignee-object-id &lt;sp_object_id&gt; \
    --assignee-principal-type ServicePrincipal \
    --role "Digital Twin Deployer" \
    --scope "/subscriptions/&lt;subscription_id&gt;"</code></pre>

                <h5 class="mt-4">Option C: Azure Portal (GUI)</h5>

                <p><strong>Part 1: Create the Custom Role</strong></p>
                <ol>
                    <li>Download: <a href="references/azure_custom_role.json" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fa-solid fa-download me-1"></i>azure_custom_role.json
                        </a></li>
                    <li>Edit the file and replace <code>REPLACE_WITH_YOUR_SUBSCRIPTION_ID</code> with your actual
                        subscription ID</li>
                    <li>In Azure Portal, navigate to your <a
                            href="https://portal.azure.com/#view/Microsoft_Azure_Billing/SubscriptionsBlade"
                            target="_blank">Subscription</a></li>
                    <li>Go to <strong>Access control (IAM)</strong> → <strong>Add</strong> → <strong>Add custom
                            role</strong></li>
                    <li>On the Basics tab, select <strong>Start from JSON</strong></li>
                    <li>Click the folder icon next to "Select a file" and upload your edited JSON file</li>
                    <li>Review the permissions on the <strong>Permissions</strong> tab</li>
                    <li>Click <strong>Review + create</strong> → <strong>Create</strong></li>
                </ol>

                <p class="mt-3"><strong>Part 2: Assign the Role to Your Service Principal</strong></p>
                <ol>
                    <li>Go to <strong>Access control (IAM)</strong> → <strong>Add</strong> → <strong>Add role
                            assignment</strong></li>
                    <li>Switch to the <strong>Privileged administrator roles</strong> tab (the custom role appears here
                        because it includes role assignment permissions)</li>
                    <li>Select <strong>Digital Twin Deployer</strong> → <strong>Next</strong></li>
                    <li>Select <strong>User, group, or service principal</strong> → <strong>Select members</strong></li>
                    <li>Search for your App Registration name and select it → <strong>Next</strong></li>
                    <li>On the <strong>Conditions</strong> tab, select <strong>"Constrain roles"</strong>
                        (Allow user to only assign roles you select):
                        <ul class="mt-2">
                            <li>Click <strong>Select roles</strong></li>
                            <li>Search for and add exactly these 3 roles:
                                <ul>
                                    <li><code>Azure Digital Twins Data Owner</code></li>
                                    <li><code>IoT Hub Data Contributor</code></li>
                                    <li><code>IoT Hub Registry Contributor</code></li>
                                </ul>
                            </li>
                            <li>Click <strong>Save</strong></li>
                        </ul>
                    </li>
                    <li>Click <strong>Review + assign</strong></li>
                </ol>

                <div class="callout tip mt-3">
                    <strong><i class="fa-solid fa-lightbulb me-2"></i>Why These 3 Roles?</strong>
                    The deployer assigns these roles to the <strong>Managed Identity</strong> (not to users):
                    <ul>
                        <li><strong>Azure Digital Twins Data Owner</strong> - For functions to read/write ADT data</li>
                        <li><strong>IoT Hub Data/Registry Contributor</strong> - For functions to access IoT Hub</li>
                    </ul>
                    By constraining to these 3 roles, the Service Principal cannot escalate privileges.
                </div>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-clock me-2"></i>Propagation Time</strong>
                    It may take a few minutes for the new custom role to propagate throughout your Azure tenant.
                </div>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-shield-halved me-2"></i>Development Alternative</strong>
                    For quick development/testing only, you can use <strong>Contributor</strong> +
                    <strong>User Access Administrator</strong> built-in roles instead. This is less secure
                    but faster to set up.
                </div>

                <h5 class="mt-4">Detailed Azure Permissions Required</h5>
                <p>The custom role requires these specific resource provider permissions:</p>

                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Layer</th>
                            <th>Resource Provider</th>
                            <th>Required Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan="3"><span class="badge text-bg-secondary">Setup</span></td>
                            <td><code>Microsoft.Resources</code></td>
                            <td>subscriptions/resourceGroups/write, delete</td>
                        </tr>
                        <tr>
                            <td><code>Microsoft.ManagedIdentity</code></td>
                            <td>userAssignedIdentities/write, delete, assign/action</td>
                        </tr>
                        <tr>
                            <td><code>Microsoft.Storage</code></td>
                            <td>storageAccounts/write, delete, listKeys/action</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-warning">L0</span></td>
                            <td><code>Microsoft.Web</code></td>
                            <td>serverfarms/write, sites/write, sites/config/write, sites/config/list/action,
                                sites/publishxml/action</td>
                        </tr>
                        <tr>
                            <td rowspan="2"><span class="badge text-bg-primary">L1</span></td>
                            <td><code>Microsoft.Devices</code></td>
                            <td>IotHubs/write, delete, listkeys/action</td>
                        </tr>
                        <tr>
                            <td><code>Microsoft.EventGrid</code></td>
                            <td>systemTopics/write, eventSubscriptions/write</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L2</span></td>
                            <td><code>Microsoft.Web</code></td>
                            <td>sites/write, sites/functions/write</td>
                        </tr>
                        <tr>
                            <td rowspan="2"><span class="badge text-bg-primary">L3</span></td>
                            <td><code>Microsoft.DocumentDB</code></td>
                            <td>databaseAccounts/write, delete, <strong>read</strong>, listKeys/action,
                                sqlDatabases/write, read,
                                sqlDatabases/containers/write, read</td>
                        </tr>
                        <tr>
                            <td><code>Microsoft.Storage</code></td>
                            <td>storageAccounts/blobServices/containers/write</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L4</span></td>
                            <td><code>Microsoft.DigitalTwins</code></td>
                            <td>digitalTwinsInstances/write, delete + dataActions for twins/models/relationships</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L5</span></td>
                            <td><code>Microsoft.Dashboard</code></td>
                            <td>grafana/write, delete</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-info">All</span></td>
                            <td><code>Microsoft.Authorization</code></td>
                            <td>roleAssignments/write, delete (for assigning roles to Managed Identity)</td>
                        </tr>
                    </tbody>
                </table>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-download me-2"></i>Complete Role Definition</strong>
                    Download the complete custom role JSON with all 69 permission actions:
                    <a href="references/azure_custom_role.json" target="_blank" class="btn btn-sm btn-primary ms-2">
                        <i class="fa-solid fa-file-code me-1"></i>azure_custom_role.json
                    </a>
                </div>

                <h5 class="mt-4"><i class="fa-solid fa-triangle-exclamation me-2"></i>Troubleshooting Authorization
                    Errors</h5>
                <p>Common error messages and solutions:</p>

                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th style="width: 40%">Error Message</th>
                            <th>Cause</th>
                            <th>Solution</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>AuthorizationFailed: ...does not have authorization to perform action 'Microsoft.DocumentDB/databaseAccounts/read'</code>
                            </td>
                            <td>Missing Cosmos DB permissions</td>
                            <td>Add <code>Microsoft.DocumentDB/*</code> actions to custom role or assign Contributor
                                role</td>
                        </tr>
                        <tr>
                            <td><code>AuthorizationFailed: ...Microsoft.DigitalTwins/...</code></td>
                            <td>Missing Azure Digital Twins permissions</td>
                            <td>Add <code>Microsoft.DigitalTwins/*</code> actions to custom role</td>
                        </tr>
                        <tr>
                            <td><code>AuthorizationFailed: ...Microsoft.Dashboard/...</code></td>
                            <td>Missing Grafana permissions</td>
                            <td>Add <code>Microsoft.Dashboard/grafana/*</code> actions to custom role</td>
                        </tr>
                        <tr>
                            <td><code>PrincipalNotFound</code></td>
                            <td>Role propagation delay</td>
                            <td>Wait 5-10 minutes after role assignment and retry</td>
                        </tr>
                    </tbody>
                </table>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-clock me-2"></i>Role Propagation Time</strong>
                    Azure RBAC role assignments can take <strong>5-10 minutes</strong> to propagate.
                    If you just assigned a role, wait before retrying the deployment.
                </div>
            </div>

            <!-- Step 4 -->
            <div class="card mb-4" id="step4">
                <h2 class="mb-3">Step 4: Find Your Allowed Regions</h2>

                <div class="callout warn">
                    <strong><i class="fa-solid fa-graduation-cap me-2"></i>Student & Restricted
                        Subscriptions</strong>
                    Azure for Students and some other subscription types have <strong>region restrictions</strong>.
                    You can only deploy resources in specific regions assigned to your account.
                </div>

                <p class="mt-3"><strong>To find your allowed regions:</strong></p>
                <ol>
                    <li>Go to <a
                            href="https://portal.azure.com/#view/Microsoft_Azure_Policy/PolicyMenuBlade/~/Assignments"
                            target="_blank">Azure Portal → Policy → Assignments</a></li>
                    <li>Look for a policy named <strong>"Allowed resource deployment regions"</strong> or similar
                    </li>
                    <li>Click on the policy to view details</li>
                    <li>Check the <strong>"Allowed locations"</strong> parameter value - this lists your permitted
                        regions</li>
                </ol>

                <p><strong>Alternative method (via CLI):</strong></p>
                <pre
                    class="p-3 rounded"><code># List policy assignments on your subscription
az policy assignment list --query "[?displayName=='Allowed resource deployment regions'].parameters.listOfAllowedLocations.value" -o json</code></pre>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-map-marker-alt me-2"></i>Common Student Regions</strong>
                    Student accounts typically have access to 5 regions. Examples include:
                    <code>norwayeast</code>, <code>switzerlandnorth</code>, <code>spaincentral</code>,
                    <code>francecentral</code>, <code>italynorth</code>.
                    Your specific allowed regions may vary.
                </div>

                <div class="callout tip mt-3">
                    <strong><i class="fa-solid fa-graduation-cap me-2"></i>Student Account Recommendation</strong>
                    <p class="mb-2">If you're using <strong>Azure for Students</strong> and encounter IoT Hub quota
                        issues,
                        try using <code>switzerlandnorth</code> for both regions:</p>
                    <pre class="p-2 rounded mb-2"><code>"azure_region": "switzerlandnorth",
"azure_region_iothub": "switzerlandnorth"</code></pre>
                    <p class="mb-2">This region has been tested and works well for student subscriptions with IoT
                        Hub
                        deployments.</p>
                    <p class="mb-0"><strong>Fallback alternatives:</strong> If <code>switzerlandnorth</code> doesn't
                        work,
                        try <code>swedencentral</code>, <code>germanywestcentral</code>, or <code>norwayeast</code>.
                        Avoid popular regions like <code>westeurope</code> and <code>northeurope</code> which often
                        have
                        capacity constraints.</p>
                </div>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-exclamation-circle me-2"></i>Note on Quota Increases</strong>
                    Azure for Students subscriptions <strong>cannot request quota increases</strong>.
                    If you hit limits in one region, try a different allowed region instead.
                </div>

                <p class="mt-2">Set your allowed region in <code>config_credentials.json</code> as
                    <code>azure_region</code>. If deployment fails with a location error,
                    check that you're using one of your allowed regions.
                </p>
            </div>

            <!-- Step 5 -->
            <div class="card mb-4" id="step5">
                <h2 class="mb-3">Step 5: Get Subscription ID</h2>

                <ol>
                    <li>In Azure Portal, go to <strong>Subscriptions</strong></li>
                    <li>Copy your <strong>Subscription ID</strong></li>
                </ol>
            </div>

            <!-- Step 6 -->
            <div class="card mb-4" id="step6">
                <h2 class="mb-3">Step 6: Configure Credentials</h2>

                <p>Add your credentials to <code>config_credentials.json</code>:</p>
                <pre class="p-3 rounded"><code>{
  "azure": {
    "azure_subscription_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "azure_tenant_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "azure_client_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "azure_client_secret": "your-client-secret-value",
    "azure_region": "westeurope"
  }
}</code></pre>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Security Warning</strong>
                    Never commit <code>config_credentials.json</code> to version control! This file is in
                    <code>.gitignore</code>.
                </div>
            </div>

            <!-- Step 7 -->
            <div class="card mb-4" id="step7">
                <h2 class="mb-3">Step 7: Verify Permissions</h2>

                <p>Use the deployer's built-in credential checker to verify your setup:</p>
                <pre class="p-3 rounded"><code># CLI
python main.py
>>> check_credentials azure

# REST API
GET /credentials/check/azure</code></pre>
            </div>

        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <script src="js/docs-nav.js" defer></script>
</body>

</html>