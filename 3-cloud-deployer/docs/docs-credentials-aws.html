<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>AWS Credentials Setup — Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-brands fa-aws me-2"></i> AWS Credentials Setup
            </h1>

            <p class="text-muted mb-4">
                Configure AWS IAM credentials and permissions for deploying your Digital Twin infrastructure.
            </p>

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="docs-credentials-setup.html">Credentials Setup</a></li>
                    <li class="breadcrumb-item active" aria-current="page">AWS</li>
                </ol>
            </nav>

            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list me-2"></i>Contents</h2>
                    <ul>
                        <li><a href="#step1">Step 1: Create an IAM User</a></li>
                        <li><a href="#step2">Step 2: Enable IAM Identity Center (for L5 Grafana)</a></li>
                        <li><a href="#step3">Step 3: Create Custom IAM Policy</a></li>
                        <li><a href="#step4">Step 4: Generate Access Keys</a></li>
                        <li><a href="#step5">Step 5: Configure Credentials</a></li>
                        <li><a href="#step6">Step 6: Verify Permissions</a></li>
                    </ul>
                </div>
            </div>

            <!-- Step 1 -->
            <div class="card mb-4" id="step1">
                <h2 class="mb-3">Step 1: Create an IAM User</h2>

                <ol>
                    <li>Sign in to the <a href="https://console.aws.amazon.com/iam/" target="_blank">AWS IAM Console</a>
                    </li>
                    <li>Navigate to <strong>Users</strong> → <strong>Create user</strong></li>
                    <li>Enter a username (e.g., <code>digital-twin-deployer</code>)</li>
                    <li>Select <strong>Attach policies directly</strong></li>
                    <li>Attach the custom policy (see Step 3) or use <code>AdministratorAccess</code> for development
                    </li>
                    <li>Complete the wizard and save the <strong>Access Key ID</strong> and <strong>Secret Access
                            Key</strong></li>
                </ol>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-shield-halved me-2"></i>AWS Best Practice</strong>
                    For production, create a dedicated IAM user with only the required permissions.
                    Avoid using root account credentials.
                </div>
            </div>

            <!-- Step 2: IAM Identity Center (NEW) -->
            <div class="card mb-4" id="step2">
                <h2 class="mb-3">Step 2: Enable IAM Identity Center <span class="badge text-bg-info">For L5
                        Grafana</span></h2>

                <p>AWS Managed Grafana requires <strong>AWS IAM Identity Center</strong> (formerly AWS SSO) to be
                    enabled in your account.
                    This is a one-time setup that cannot be automated via Terraform.</p>

                <div class="callout warn mb-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Critical: Region Selection</strong>
                    <p class="mb-0">IAM Identity Center is <strong>region-specific</strong> and can only exist in ONE
                        region per account.
                        <strong>You must enable it in the SAME region</strong> where your AWS resources will be deployed
                        (typically <code>eu-central-1</code> for this project).
                    </p>
                </div>

                <h5 class="mt-4"><i class="fa-solid fa-display me-2"></i>Option A: AWS Console (Recommended)</h5>
                <ol>
                    <li><strong>Select the correct region first</strong>: In the AWS Console, click the region dropdown
                        (top-right corner) and select <code>EU (Frankfurt) eu-central-1</code> (or your preferred
                        region)</li>
                    <li>Navigate to <a href="https://console.aws.amazon.com/singlesignon/" target="_blank">AWS IAM
                            Identity Center Console</a></li>
                    <li>You will see one of two screens:
                        <ul>
                            <li><strong>If not enabled</strong>: Click the <strong class="text-primary">Enable</strong>
                                button</li>
                            <li><strong>If already enabled in another region</strong>: You'll see an info box stating
                                "IAM Identity Center is currently configured in the [Region] Region" - see
                                <a href="#change-sso-region">"Changing SSO Region"</a> below
                            </li>
                        </ul>
                    </li>
                    <li>When prompted, select the identity source:
                        <ul>
                            <li><strong>Identity Center directory</strong> (default, recommended for most users)</li>
                        </ul>
                    </li>
                    <li>Wait 1-2 minutes for the service to be provisioned</li>
                    <li>Verify the dashboard shows "IAM Identity Center is enabled"</li>
                </ol>

                <h5 class="mt-4"><i class="fa-solid fa-terminal me-2"></i>Option B: AWS CLI</h5>
                <p>If you have the AWS CLI configured with administrative permissions:</p>
                <pre class="p-3 rounded"><code># IMPORTANT: Specify the region where your resources will be deployed!
aws sso-admin create-instance --region eu-central-1

# Verify it was created
aws sso-admin list-instances --region eu-central-1</code></pre>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-circle-info me-2"></i>Note</strong>
                    You can only create <strong>one</strong> IAM Identity Center instance per AWS account.
                    The CLI command will fail if an instance already exists (which is fine - it means it's already
                    enabled).
                </div>

                <!-- Why Region Matters -->
                <h5 class="mt-4" id="why-region-matters"><i class="fa-solid fa-map-location-dot me-2"></i>Why Region
                    Matters</h5>
                <p>IAM Identity Center is a <strong>single-region service</strong>. The Terraform AWS provider can only
                    detect SSO instances in the region it's configured for. If your SSO is in <code>us-east-1</code>
                    but Terraform runs in <code>eu-central-1</code>, it will fail with an empty
                    <code>identity_store_id</code>.
                </p>

                <p><strong>Two solutions exist:</strong></p>
                <ul>
                    <li><strong>Recommended</strong>: Enable SSO in the same region as your resources
                        (<code>eu-central-1</code>)</li>
                    <li><strong>Alternative</strong>: Configure <code>aws_sso_region</code> in your credentials (see
                        below)</li>
                </ul>

                <!-- If SSO is in a different region -->
                <h5 class="mt-4"><i class="fa-solid fa-sliders me-2"></i>If SSO is Already in a Different Region</h5>
                <p>If you already enabled SSO in a different region (e.g., <code>us-east-1</code>) and don't want to
                    change it, add the <code>aws_sso_region</code> field to your credentials file:</p>
                <pre class="p-3 rounded"><code>{
  "aws": {
    "aws_access_key_id": "AKIA...",
    "aws_secret_access_key": "...",
    "aws_region": "eu-central-1",
    "aws_sso_region": "us-east-1"
  }
}</code></pre>

                <!-- Changing SSO Region -->
                <h5 class="mt-4" id="change-sso-region"><i class="fa-solid fa-arrows-rotate me-2"></i>Changing SSO
                    Region (If Needed)</h5>
                <p>If you prefer to move your SSO to the same region as your resources, you must <strong>delete and
                        recreate</strong> it.
                    Note: This deletes all SSO users, groups, and permission sets!</p>

                <div class="callout warn mb-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Warning: Data Loss</strong>
                    Deleting IAM Identity Center removes ALL users, groups, permission sets, and application
                    assignments.
                    Only proceed if you haven't configured any users yet, or are willing to reconfigure them.
                </div>

                <ol>
                    <li>Go to <a href="https://console.aws.amazon.com/singlesignon/" target="_blank">IAM Identity Center
                            Console</a>
                        (it will auto-redirect to the region where SSO is enabled)</li>
                    <li>In the left navigation, click <strong>Settings</strong></li>
                    <li>Select the <strong>Management</strong> tab</li>
                    <li>Scroll down to <strong>Delete IAM Identity Center configuration</strong></li>
                    <li>Click <strong>Delete</strong></li>
                    <li>Check all confirmation boxes and type the instance name to confirm</li>
                    <li>Wait for deletion to complete (1-2 minutes)</li>
                    <li><strong>Switch to your desired region</strong> (e.g., <code>eu-central-1</code>) using the
                        region dropdown</li>
                    <li>Navigate to IAM Identity Center again and click <strong>Enable</strong></li>
                </ol>

                <h5 class="mt-4">Verify Setup</h5>
                <p>After enabling, verify that IAM Identity Center is active in the correct region:</p>
                <pre class="p-3 rounded"><code># Should return your SSO instance ARN (replace region as needed)
aws sso-admin list-instances --region eu-central-1 --query "Instances[0].InstanceArn" --output text</code></pre>
            </div>

            <!-- Step 3 (was Step 2) -->
            <div class="card mb-4" id="step3">
                <h2 class="mb-3">Step 3: Create Custom IAM Policy</h2>

                <p>Instead of granting full <code>AdministratorAccess</code>, create a custom policy with minimal
                    required permissions:</p>

                <ol>
                    <li>Navigate to <strong>Policies</strong> → <strong>Create policy</strong></li>
                    <li>Select the <strong>JSON</strong> tab</li>
                    <li>Copy the policy document from: <a href="references/aws_deployer_policy.json" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fa-solid fa-download me-1"></i>aws_deployer_policy.json
                        </a></li>
                    <li>Paste into the JSON editor and click <strong>Next</strong></li>
                    <li>Name the policy (e.g., <code>DigitalTwinDeployerPolicy</code>)</li>
                    <li>Click <strong>Create policy</strong></li>
                </ol>

                <h5 class="mt-4">Policy Summary</h5>
                <p>The policy includes permissions for:</p>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Layer</th>
                            <th>Services</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge text-bg-success">Setup</span></td>
                            <td>Resource Groups, IAM</td>
                            <td>Resource grouping, IAM role tagging</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-warning">L0</span></td>
                            <td>IAM, Lambda</td>
                            <td>Multi-cloud HTTP receivers (Ingestion, Writers, Readers)</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L1</span></td>
                            <td>IAM, Lambda, IoT Core, STS</td>
                            <td>IoT Dispatcher, Thing registration, Topic rules</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L2</span></td>
                            <td>IAM, Lambda, Step Functions</td>
                            <td>Persister, Event processing, State machines</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L3</span></td>
                            <td>DynamoDB, S3, EventBridge, Lambda</td>
                            <td>Hot/Cold/Archive storage, Data movers</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L4</span></td>
                            <td>IoT TwinMaker, S3, Lambda</td>
                            <td>Digital Twin workspace, Component types</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-primary">L5</span></td>
                            <td>Managed Grafana, IAM</td>
                            <td>Visualization dashboards</td>
                        </tr>
                        <tr>
                            <td><span class="badge text-bg-info">Check</span></td>
                            <td>IAM</td>
                            <td>Self-inspection for <code>check_credentials</code></td>
                        </tr>
                    </tbody>
                </table>

                <h5 class="mt-4">Alternative: AWS CLI (One Command)</h5>
                <p>If you have the AWS CLI configured, create the policy with a single command:</p>
                <pre class="p-3 rounded"><code># Download the policy file first, then run:
aws iam create-policy \
    --policy-name DigitalTwinDeployerPolicy \
    --policy-document file://aws_deployer_policy.json

# Then attach to your user:
aws iam attach-user-policy \
    --user-name digital-twin-deployer \
    --policy-arn arn:aws:iam::YOUR_ACCOUNT_ID:policy/DigitalTwinDeployerPolicy</code></pre>
            </div>

            <!-- Step 4 -->
            <div class="card mb-4" id="step4">
                <h2 class="mb-3">Step 4: Generate Access Keys</h2>

                <ol>
                    <li>Select your IAM user → <strong>Security credentials</strong> tab</li>
                    <li>Under <strong>Access keys</strong>, click <strong>Create access key</strong></li>
                    <li>Select <strong>Application running outside AWS</strong></li>
                    <li>Click <strong>Create access key</strong></li>
                    <li>
                        <strong>Important:</strong> Download the <code>.csv</code> file or copy both keys immediately.
                        The secret key is only shown once!
                    </li>
                </ol>
            </div>

            <!-- Step 5 -->
            <div class="card mb-4" id="step5">
                <h2 class="mb-3">Step 5: Configure Credentials</h2>

                <p>Add your credentials to <code>config_credentials.json</code>:</p>
                <pre class="p-3 rounded"><code>{
  "aws": {
    "aws_access_key_id": "AKIAIOSFODNN7EXAMPLE",
    "aws_secret_access_key": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
    "aws_region": "eu-central-1",
    "aws_sso_region": ""
  }
}</code></pre>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-circle-info me-2"></i>SSO Region</strong>
                    Leave <code>aws_sso_region</code> empty if IAM Identity Center is in the same region as your
                    resources.
                    Only set it if SSO is in a different region (e.g., <code>"us-east-1"</code>).
                </div>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Security Warning</strong>
                    Never commit <code>config_credentials.json</code> to version control! This file is in
                    <code>.gitignore</code>.
                </div>
            </div>

            <!-- Step 6 -->
            <div class="card mb-4" id="step6">
                <h2 class="mb-3">Step 6: Verify Permissions</h2>

                <p>Use the deployer's built-in credential checker to verify your setup:</p>
                <pre class="p-3 rounded"><code># CLI
python main.py
>>> check_credentials aws

# REST API
POST /credentials/check/aws</code></pre>

                <p class="mt-3">
                    For the complete list of required permissions per layer, see the
                    <a href="docs-aws-deployment.html#iam-permissions">AWS Deployment Guide - IAM Permissions</a>.
                </p>
            </div>

        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <script src="js/docs-nav.js" defer></script>
</body>

</html>