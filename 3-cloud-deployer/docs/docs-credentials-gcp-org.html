<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>GCP Organization Account Setup — Deployer Documentation</title>
    <link rel="icon" type="image/x-icon" href="references/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/docs_styles.css" />
</head>

<body>

    <div class="layout">
        <aside id="nav-placeholder"></aside>

        <main class="p-4">
            <h1 class="mb-3">
                <i class="fa-brands fa-google me-2"></i> GCP Organization Account Setup
            </h1>

            <p class="text-muted mb-4">
                Set up GCP credentials for <strong>Google Workspace or Cloud Identity accounts</strong>
                with an organization. Terraform auto-creates projects.
            </p>

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="docs-credentials-setup.html">Credentials Setup</a></li>
                    <li class="breadcrumb-item"><a href="docs-credentials-gcp.html">GCP</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Organization Account</li>
                </ol>
            </nav>

            <!-- Overview -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <i class="fa-solid fa-circle-info me-2"></i>How Auto-Project Creation Works
                </div>
                <div class="card-body">
                    <p>Terraform <strong>creates a new GCP project</strong> for each Digital Twin deployment. To do
                        this,
                        you need a service account in an <strong>existing "admin" project</strong> with
                        organization-level
                        permissions.</p>

                    <div class="bg-light p-3 rounded mb-3">
                        <pre class="mb-0"><code>┌─────────────────────────────────────────────────────────────┐
│  YOUR EXISTING "ADMIN" PROJECT                              │
│  └── Service Account (you create this once)                 │
│        ├── Has: roles/resourcemanager.projectCreator        │
│        │        (at organization or folder level)           │
│        └── Has: roles/billing.user (on billing account)     │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼ Terraform uses this SA to create:
┌─────────────────────────────────────────────────────────────┐
│  NEW DEPLOYMENT PROJECT: {twin-name}-project                │
│  └── All resources: Pub/Sub, Functions, Firestore, etc.    │
└─────────────────────────────────────────────────────────────┘</code></pre>
                    </div>

                    <p class="mb-0"><strong>Advantage:</strong> Each Digital Twin gets its own isolated project, making
                        cleanup and resource management easier.</p>
                </div>
            </div>

            <!-- Table of Contents -->
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="mb-3"><i class="fa-solid fa-list me-2"></i>Contents</h2>
                    <ul>
                        <li><a href="#step1">Step 1: Get Your Billing Account ID</a></li>
                        <li><a href="#step2">Step 2: Create Service Account & Download Key</a></li>
                        <li><a href="#step3">Step 3: Grant Billing Permissions</a></li>
                        <li><a href="#step4">Step 4: Grant Project Creator Permission</a></li>
                        <li><a href="#step5">Step 5: Enable Required APIs <span class="text-muted">(Optional)</span></a>
                        </li>
                        <li><a href="#step6">Step 6: Configure Credentials</a></li>
                        <li><a href="#step7">Step 7: Verify Permissions</a></li>
                    </ul>
                </div>
            </div>

            <!-- Step 1 -->
            <div class="card mb-4" id="step1">
                <h2 class="mb-3">Step 1: Get Your Billing Account ID</h2>

                <p><strong>To find your billing account ID:</strong></p>
                <pre class="p-3 rounded"><code># Via gcloud CLI
gcloud billing accounts list

# Or in Console: https://console.cloud.google.com/billing</code></pre>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>Billing Account Format</strong>
                    Billing account IDs look like: <code>0XXXXX-XXXXXX-XXXXXX</code>
                </div>
            </div>

            <!-- Step 2: Create Service Account & Download Key -->
            <div class="card mb-4" id="step2">
                <h2 class="mb-3">Step 2: Create Service Account & Download Key</h2>

                <div class="callout warn">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Important: Use an Existing
                        Project</strong>
                    <p class="mb-0">The service account must be created in an <strong>existing</strong> GCP project
                        (your "admin" or "seed" project). This SA will then be used to create <em>new</em>
                        deployment projects via Terraform.</p>
                </div>

                <h5 class="mt-4">What You Need</h5>
                <ul>
                    <li>An existing GCP project (any project you have access to)</li>
                    <li>Owner or IAM Admin permissions on that project</li>
                </ul>

                <h5 class="mt-4">Create the Service Account</h5>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">IAM &
                            Admin → Service Accounts</a></li>
                    <li>Select your <strong>existing</strong> project from the dropdown at the top</li>
                    <li>Click <strong>Create Service Account</strong></li>
                    <li>Name: <code>digital-twin-deployer</code></li>
                    <li>Click <strong>Create and Continue</strong></li>
                    <li>Skip the optional steps and click <strong>Done</strong></li>
                </ol>

                <h5 class="mt-4">Download the Key</h5>
                <ol>
                    <li>Click on the service account you just created</li>
                    <li>Go to <strong>Keys</strong> tab</li>
                    <li>Click <strong>Add Key</strong> → <strong>Create new key</strong></li>
                    <li>Select <strong>JSON</strong> format</li>
                    <li>Click <strong>Create</strong> — the key file downloads automatically</li>
                    <li>Save the file securely (e.g., <code>~/gcp-credentials.json</code>)</li>
                </ol>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-copy me-2"></i>Note Your Service Account Email</strong>
                    <p class="mb-0">You'll need your service account email for the next steps. It looks like:
                        <code>digital-twin-deployer@YOUR_PROJECT.iam.gserviceaccount.com</code>
                    </p>
                </div>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Security Warning</strong>
                    Keep the JSON key file secure! Never commit it to version control.
                </div>
            </div>

            <!-- Step 3: Grant Billing Permissions -->
            <div class="card mb-4" id="step3">
                <h2 class="mb-3">Step 3: Grant Billing Permissions</h2>

                <div class="callout warn">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Critical Step</strong>
                    <p class="mb-0">Without billing permissions, Terraform cannot link the new project to your billing
                        account and deployment will fail.</p>
                </div>

                <h5 class="mt-4">Why This Is Needed</h5>
                <p>When Terraform creates a new GCP project, it must link that project to a billing account. This
                    requires the <code>billing.resourceAssociations.create</code> permission, which must be granted
                    <strong>on the billing account itself</strong> — not on a project.
                </p>

                <h5 class="mt-4">Grant the Role via Console</h5>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/billing" target="_blank">Billing → Manage
                            billing accounts</a></li>
                    <li>Click on your billing account</li>
                    <li>In the left menu, click <strong>Account management</strong></li>
                    <li>Click <strong>Add principal</strong></li>
                    <li>Enter your service account email from Step 2:
                        <code>digital-twin-deployer@YOUR_PROJECT.iam.gserviceaccount.com</code>
                    </li>
                    <li>Select role: <strong>Billing Account User</strong> (<code>roles/billing.user</code>)</li>
                    <li>Click <strong>Save</strong></li>
                </ol>

                <div class="callout tip mt-3">
                    <strong><i class="fa-solid fa-lightbulb me-2"></i>Minimum Permission</strong>
                    <p class="mb-0">The <code>roles/billing.user</code> role only allows linking projects to the billing
                        account. It does not grant access to view billing reports or modify billing settings.</p>
                </div>
            </div>

            <!-- Step 4: Grant Project Creator Permission -->
            <div class="card mb-4" id="step4">
                <h2 class="mb-3">Step 4: Grant Project Creator Permission</h2>

                <div class="callout warn">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Critical Step</strong>
                    <p class="mb-0">For Terraform to create new projects, the service account needs
                        <code>roles/resourcemanager.projectCreator</code> at the <strong>organization or folder
                            level</strong> (not project level!).
                    </p>
                </div>

                <h5 class="mt-4">Grant the Role</h5>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/iam-admin/iam" target="_blank">IAM & Admin →
                            IAM</a></li>
                    <li>At the top, switch to your <strong>Organization</strong> (or folder) — not a project</li>
                    <li>Click <strong>Grant Access</strong></li>
                    <li>Enter your service account email from Step 2:
                        <code>digital-twin-deployer@YOUR_PROJECT.iam.gserviceaccount.com</code>
                    </li>
                    <li>Add role: <strong>Project Creator</strong> (<code>roles/resourcemanager.projectCreator</code>)
                    </li>
                    <li>Click <strong>Save</strong></li>
                </ol>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>How This Works</strong>
                    <p class="mb-0">The service account (from your admin project) now has permission to create new
                        projects under your organization. Each Digital Twin deployment will create a new project
                        named <code>{twin-name}-project</code>.</p>
                </div>
            </div>

            <!-- Step 5 (Optional): Enable APIs -->
            <div class="card mb-4" id="step5">
                <h2 class="mb-3">
                    <span class="badge text-bg-secondary me-2">Optional</span>
                    Step 5: Enable Required APIs
                </h2>

                <div class="callout info tip">
                    <strong><i class="fa-solid fa-robot me-2"></i>Terraform Handles This Automatically</strong>
                    <p class="mb-0">Terraform enables all required APIs during deployment. Skip this step unless you
                        need to pre-enable APIs for credential checking.</p>
                </div>

                <details class="mt-3">
                    <summary><strong>View API list (reference only)</strong></summary>
                    <table class="table table-sm table-striped mt-2">
                        <thead>
                            <tr>
                                <th>Layer</th>
                                <th>APIs</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="badge text-bg-secondary">Setup</span></td>
                                <td><code>cloudresourcemanager, iam, storage</code></td>
                            </tr>
                            <tr>
                                <td><span class="badge text-bg-primary">L1</span></td>
                                <td><code>pubsub, eventarc</code></td>
                            </tr>
                            <tr>
                                <td><span class="badge text-bg-primary">L2</span></td>
                                <td><code>cloudfunctions, run, cloudbuild</code></td>
                            </tr>
                            <tr>
                                <td><span class="badge text-bg-primary">L3</span></td>
                                <td><code>firestore, storage, cloudscheduler</code></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="callout warn">
                        <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>L4/L5 Not Available</strong>
                        GCP does not have managed Digital Twin or Grafana equivalents.
                    </div>
                </details>
            </div>

            <!-- Step 6 -->
            <div class="card mb-4" id="step6">
                <h2 class="mb-3">Step 6: Configure Credentials</h2>

                <p>Add your credentials to <code>config_credentials.json</code>:</p>
                <pre class="p-3 rounded"><code>{
  "gcp": {
    "gcp_billing_account": "0XXXXX-XXXXXX-XXXXXX",
    "gcp_credentials_file": "/path/to/gcp-credentials.json",
    "gcp_region": "europe-west1"
  }
}</code></pre>

                <table class="table table-sm mt-3">
                    <thead>
                        <tr>
                            <th>Field</th>
                            <th>Description</th>
                            <th>Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>gcp_billing_account</code></td>
                            <td>Billing account ID for project creation (format: <code>0XXXXX-XXXXXX-XXXXXX</code>)</td>
                            <td><strong>Yes</strong></td>
                        </tr>
                        <tr>
                            <td><code>gcp_credentials_file</code></td>
                            <td>Path to service account JSON key</td>
                            <td><strong>Yes</strong></td>
                        </tr>
                        <tr>
                            <td><code>gcp_region</code></td>
                            <td>GCP region for resources</td>
                            <td><strong>Yes</strong></td>
                        </tr>
                    </tbody>
                </table>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-info-circle me-2"></i>Project ID is Auto-Generated</strong>
                    <p class="mb-0">The project ID is automatically generated as
                        <code>{digital_twin_name}-project</code>.
                        You do not need to specify it in the credentials.
                    </p>
                </div>

                <div class="callout warn mt-3">
                    <strong><i class="fa-solid fa-exclamation-triangle me-2"></i>Precedence Rule</strong>
                    <p class="mb-0">If you accidentally provide both <code>gcp_project_id</code> and
                        <code>gcp_billing_account</code>, the system uses <code>gcp_project_id</code> (existing project
                        mode)
                        and ignores the billing account. To use auto-create mode, leave <code>gcp_project_id</code>
                        empty.
                    </p>
                </div>

                <div class="callout info mt-3">
                    <strong><i class="fa-solid fa-map-marker-alt me-2"></i>Recommended Regions</strong>
                    <code>europe-west1</code> (Belgium), <code>us-central1</code> (Iowa),
                    <code>asia-east1</code> (Taiwan) have good availability for all services.
                </div>
            </div>

            <!-- Step 7 -->
            <div class="card mb-4" id="step7">
                <h2 class="mb-3">Step 7: Verify Permissions</h2>

                <p>Use the deployer's built-in credential checker to verify your setup:</p>
                <pre class="p-3 rounded"><code># CLI
python main.py
>>> check_credentials gcp

# REST API
GET /permissions/verify/gcp</code></pre>

                <p>The checker validates:</p>
                <ul>
                    <li>Service account key file exists and is valid JSON</li>
                    <li>Project access (from the admin project)</li>
                    <li>Required APIs are enabled</li>
                </ul>
            </div>

            <!-- Alternative -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <i class="fa-solid fa-user me-2"></i>No Organization?
                </div>
                <div class="card-body">
                    <p class="mb-0">If you're using a personal Gmail account (not Google Workspace), use the
                        <a href="docs-credentials-gcp-private.html"><strong>Private Account Setup</strong></a> instead.
                        This simpler flow uses an existing project without needing organization-level permissions.
                    </p>
                </div>
            </div>

        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <button id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 shadow fade p-3"
        style="display:none;">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <script src="js/docs-nav.js" defer></script>
</body>

</html>